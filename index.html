<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocko's Modern Gym App</title>
    
    <meta name="description" content="Your complete strength training companion - track workouts, calculate plates, and monitor progress">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rocko's Gym">
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸ’ª%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸ’ª%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #0a0e27;
            overflow-x: hidden;
        }
        
        .bg-animated {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 25%, #0a0e27 50%, #2d1b4e 75%, #0a0e27 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.5);
        }
        
        .glow-blue {
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3);
        }
        
        .glow-purple {
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.5), 0 0 60px rgba(168, 85, 247, 0.3);
        }
        
        .glow-green {
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.5), 0 0 60px rgba(34, 197, 94, 0.3);
        }
        
        .hover-lift {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hover-lift:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
        }
        
        .hover-scale:hover {
            transform: scale(1.02);
        }
        
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(168, 85, 247, 0.2));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .calendar-day:hover::before {
            opacity: 1;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #a855f7, #ec4899);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes progressSlide {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 0%; }
        }
        
        .progress-animated {
            background: linear-gradient(90deg, #3b82f6, #a855f7, #ec4899, #3b82f6);
            background-size: 200% 100%;
            animation: progressSlide 2s linear infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .float-animation {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out forwards;
        }
        
        .stagger-1 { animation-delay: 0.1s; }
        .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; }
        .stagger-4 { animation-delay: 0.4s; }
        
        input:focus, select:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 0 20px rgba(59, 130, 246, 0.3);
        }

        select option {
            color: black;
            background: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); }
        }
        
        .stat-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }
        
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .ripple {
            position: relative;
            overflow: hidden;
        }
        
        .ripple::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .ripple:active::after {
            width: 300px;
            height: 300px;
        }

        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            opacity: 0.7;
            animation: confetti-fall 3s ease-out forwards;
        }
        
        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-animated text-white min-h-screen">
    <div class="fixed inset-0 bg-gradient-to-br from-blue-500/5 via-purple-500/5 to-pink-500/5 pointer-events-none"></div>
    
    <div id="confetti-container"></div>
    
    <div id="app" class="relative max-w-6xl mx-auto p-4 md:p-6"></div>

    <script>
        // State Management
        let state = {
            view: 'calc',
            weight: '', // For Plate Calculator
            unit: 'lbs', // SHARED unit for all calculators
            bar: 'standard',
            exercise: 'squat', // For Strength Standards
            bodyweight: '',
            gender: 'male',
            category: 'natural',
            strengthWeight: '', // For Strength Standards weight
            userName: localStorage.getItem('userName') || '',
            workouts: JSON.parse(localStorage.getItem('workouts') || '[]'),
            plans: JSON.parse(localStorage.getItem('plans') || '{}'),
            routines: JSON.parse(localStorage.getItem('routines') || '[]'),
            currentSets: [],
            currentRoutineSets: [],
            currentRoutineName: '',
            prs: JSON.parse(localStorage.getItem('prs') || '[]'),
            workoutExercise: 'squat',
            workoutWeight: '',
            workoutReps: '',
            workoutSets: '1',
            logActivityType: 'strength',
            routineActivityType: 'strength',
            workoutCardioExercise: 'run',
            workoutCardioDuration: '',
            showNameDialog: false,
            showPRDialog: false,
            prData: null,
            repWeight: '', // For 1RM
            reps: '', // For 1RM
            selectedDate: new Date(),
            calendarMonth: new Date().getMonth(),
            calendarYear: new Date().getFullYear(),
            showCalendarModal: false,
            selectedCalendarDate: null,
            planType: 'activity',
            planActivityType: 'strength',
            planStrengthExercise: 'squat',
            planCardioExercise: 'run',
            planCardioDuration: '',
            planNotes: '',
            planRoutineId: '',
            pendingWorkout: null,
            pendingPRs: [],
            strengthResult: null,
            oneRMResult: null,
            plateResult: null,
            progressChartType: 'weight' // For progress chart
        };

        // --- DATA MIGRATION FIX ---
        (function migrateData() {
            let needsSave = false;
            state.workouts.forEach(w => {
                if (w.sets && !w.activities) {
                    w.activities = w.sets.map(s => ({...s, type: 'strength'})); // Add type
                    delete w.sets;
                    needsSave = true;
                }
            });
            if (needsSave) {
                console.log('Migrating old workout data...');
                localStorage.setItem('workouts', JSON.stringify(state.workouts));
            }
        })();


        // Exercise Data (Alphabetized by name)
        const exercises = {
            abWheel: 'Ab Wheel Rollout',
            arnoldPress: 'Arnold Press',
            stoneLoad: 'Atlas Stone Load',
            axlePress: 'Axle Press',
            backExtension: 'Back Extension',
            row: 'Barbell Row',
            bench: 'Bench Press',
            bicepcurl: 'Bicep Curl',
            boxSquat: 'Box Squat',
            bulgarianSplit: 'Bulgarian Split Squat',
            cableRow: 'Cable Row',
            cableWoodchop: 'Cable Woodchop',
            calfRaise: 'Calf Raise',
            chestRow: 'Chest Supported Row',
            chinups: 'Chin-ups',
            cleanJerk: 'Clean and Jerk',
            closeBench: 'Close Grip Bench',
            deadlift: 'Deadlift',
            declineBench: 'Decline Bench Press',
            deficitDL: 'Deficit Deadlift',
            dips: 'Dips',
            dbBench: 'Dumbbell Bench Press',
            dbOHP: 'Dumbbell Overhead Press',
            dbRow: 'Dumbbell Row',
            facePulls: 'Face Pulls',
            farmersWalk: "Farmer's Walk",
            floorPress: 'Floor Press',
            frontSquat: 'Front Squat',
            gluteBridge: 'Glute Bridge',
            gobletSquat: 'Goblet Squat',
            hackSquat: 'Hack Squat',
            hammerCurl: 'Hammer Curl',
            hangClean: 'Hang Clean',
            hangingLegRaise: 'Hanging Leg Raise',
            hipThrust: 'Hip Thrust',
            inclineBench: 'Incline Bench Press',
            latPulldown: 'Lat Pulldown',
            lateralRaise: 'Lateral Raise',
            legCurl: 'Leg Curl',
            legExtension: 'Leg Extension',
            legPress: 'Leg Press',
            logPress: 'Log Press',
            lunges: 'Lunges',
            ohp: 'Overhead Press',
            pauseBench: 'Pause Bench Press',
            pauseSquat: 'Pause Squat',
            pendlayRow: 'Pendlay Row',
            plank: 'Plank',
            plateHold: 'Plate Hold',
            powerClean: 'Power Clean',
            powerSnatch: 'Power Snatch',
            preacherCurl: 'Preacher Curl',
            pullups: 'Pull-ups',
            pushPress: 'Push Press',
            rackPull: 'Rack Pull',
            romanianDL: 'Romanian Deadlift',
            russianTwist: 'Russian Twist',
            seatedCalfRaise: 'Seated Calf Raise',
            seatedOHP: 'Seated Overhead Press',
            shrugs: 'Shrugs',
            skullcrushers: 'Skullcrushers',
            snatch: 'Snatch',
            squat: 'Squat',
            stiffLegDL: 'Stiff Leg Deadlift',
            sumoDeadlift: 'Sumo Deadlift',
            tbarRow: 'T-Bar Row',
            tireFlip: 'Tire Flip',
            trapBarDL: 'Trap Bar Deadlift',
            tricepExt: 'Tricep Extension',
            vikingPress: 'Viking Press',
            yokeWalk: 'Yoke Walk'
        };

        const cardioExercises = {
            run: 'Running',
            cycle: 'Cycling',
            rowing: 'Rowing Machine',
            elliptical: 'Elliptical',
            stairs: 'Stair Climber',
            jumpRope: 'Jump Rope',
            walk: 'Walking (Incline)',
            swim: 'Swimming',
            other: 'Other Cardio'
        };

        // Bar and Plate Data
        const bars = { 
            standard: { lbs: 45, kg: 20 }, 
            womens: { lbs: 35, kg: 15 }, 
            ezBar: { lbs: 25, kg: 11 }, 
            trap: { lbs: 60, kg: 27 } 
        };
        
        const barNames = { 
            standard: 'Standard Bar (45/20)', 
            womens: "Women's Bar (35/15)", 
            ezBar: 'EZ Curl Bar (25/11)', 
            trap: 'Trap Bar (60/27)' 
        };
        
        const plates = { 
            lbs: [45, 35, 25, 10, 5, 2.5], 
            kg: [25, 20, 15, 10, 5, 2.5, 1.25] 
        };
        
        // Default Routines
        const defaultRoutines = [
            {
                id: 1001, name: 'Default: Full Body', activities: [
                    { id: 1, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' },
                    { id: 2, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' },
                    { id: 3, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' },
                    { id: 4, type: 'strength', exercise: 'Bench Press', weight: '', reps: '5', unit: 'lbs' },
                    { id: 5, type: 'strength', exercise: 'Bench Press', weight: '', reps: '5', unit: 'lbs' },
                    { id: 6, type: 'strength', exercise: 'Bench Press', weight: '', reps: '5', unit: 'lbs' },
                    { id: 7, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '5', unit: 'lbs' },
                    { id: 8, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '5', unit: 'lbs' },
                    { id: 9, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '5', unit: 'lbs' },
                    { id: 10, type: 'cardio', exercise: 'Running', duration: 10 }
                ]
            },
            {
                id: 1002, name: 'Default: Push Day', activities: [
                    { id: 11, type: 'strength', exercise: 'Bench Press', weight: '', reps: '8', unit: 'lbs' },
                    { id: 12, type: 'strength', exercise: 'Bench Press', weight: '', reps: '8', unit: 'lbs' },
                    { id: 13, type: 'strength', exercise: 'Bench Press', weight: '', reps: '8', unit: 'lbs' },
                    { id: 14, type: 'strength', exercise: 'Overhead Press', weight: '', reps: '10', unit: 'lbs' },
                    { id: 15, type: 'strength', exercise: 'Overhead Press', weight: '', reps: '10', unit: 'lbs' },
                    { id: 16, type: 'strength', exercise: 'Dips', weight: '', reps: '12', unit: 'lbs' },
                    { id: 17, type: 'strength', exercise: 'Dips', weight: '', reps: '12', unit: 'lbs' }
                ]
            },
            {
                id: 1003, name: 'Default: Pull Day', activities: [
                    { id: 18, type: 'strength', exercise: 'Deadlift', weight: '', reps: '5', unit: 'lbs' },
                    { id: 19, type: 'strength', exercise: 'Pull-ups', weight: '', reps: '8', unit: 'lbs' },
                    { id: 20, type: 'strength', exercise: 'Pull-ups', weight: '', reps: '8', unit: 'lbs' },
                    { id: 21, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '10', unit: 'lbs' },
                    { id: 22, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '10', unit: 'lbs' },
                    { id: 23, type: 'strength', exercise: 'Bicep Curl', weight: '', reps: '12', unit: 'lbs' }
                ]
            },
            {
                id: 1004, name: 'Default: Leg Day', activities: [
                    { id: 24, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' },
                    { id: 25, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' },
                    { id: 26, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' },
                    { id: 27, type: 'strength', exercise: 'Romanian Deadlift', weight: '', reps: '10', unit: 'lbs' },
                    { id: 28, type: 'strength', exercise: 'Romanian Deadlift', weight: '', reps: '10', unit: 'lbs' },
                    { id: 29, type: 'strength', exercise: 'Leg Press', weight: '', reps: '12', unit: 'lbs' },
                    { id: 30, type: 'strength', exercise: 'Calf Raise', weight: '', reps: '15', unit: 'lbs' }
                ]
            },
            {
                id: 1005, name: 'Default: Cardio Blast', activities: [
                    { id: 31, type: 'cardio', exercise: 'Running', duration: 15 },
                    { id: 32, type: 'cardio', exercise: 'Cycling', duration: 15 },
                    { id: 33, type: 'cardio', exercise: 'Rowing Machine', duration: 10 }
                ]
            }
        ];

        // Load default routines if none exist
        (function loadDefaultRoutines() {
            if (!state.routines.some(r => r.id === 1001)) {
                console.log('Loading default routines...');
                state.routines = [...defaultRoutines, ...state.routines];
                localStorage.setItem('routines', JSON.stringify(state.routines));
            }
        })();

        // Strength Standards Data
        const strengthStandards = {
            natural: {
                male: {
                    squat: {untrained: 0.65, novice: 1.15, intermediate: 1.70, advanced: 2.20, elite: 2.75},
                    bench: {untrained: 0.50, novice: 0.75, intermediate: 1.25, advanced: 1.75, elite: 2.25},
                    deadlift: {untrained: 0.80, novice: 1.40, intermediate: 2.00, advanced: 2.60, elite: 3.25},
                    ohp: {untrained: 0.35, novice: 0.55, intermediate: 0.85, advanced: 1.15, elite: 1.50},
                    row: {untrained: 0.40, novice: 0.70, intermediate: 1.10, advanced: 1.50, elite: 1.90}
                },
                female: {
                    squat: {untrained: 0.45, novice: 0.75, intermediate: 1.20, advanced: 1.60, elite: 2.05},
                    bench: {untrained: 0.30, novice: 0.50, intermediate: 0.80, advanced: 1.10, elite: 1.45},
                    deadlift: {untrained: 0.55, novice: 0.95, intermediate: 1.45, advanced: 1.90, elite: 2.45},
                    ohp: {untrained: 0.20, novice: 0.35, intermediate: 0.55, advanced: 0.75, elite: 1.00},
                    row: {untrained: 0.25, novice: 0.45, intermediate: 0.75, advanced: 1.00, elite: 1.30}
                }
            },
            enhanced: {
                male: {
                    squat: {untrained: 0.65, novice: 1.15, intermediate: 1.90, advanced: 2.60, elite: 3.50},
                    bench: {untrained: 0.50, novice: 0.75, intermediate: 1.40, advanced: 2.10, elite: 2.90},
                    deadlift: {untrained: 0.80, novice: 1.40, intermediate: 2.20, advanced: 3.00, elite: 4.20},
                    ohp: {untrained: 0.35, novice: 0.55, intermediate: 0.95, advanced: 1.40, elite: 1.95},
                    row: {untrained: 0.40, novice: 0.70, intermediate: 1.25, advanced: 1.80, elite: 2.45}
                },
                female: {
                    squat: {untrained: 0.45, novice: 0.75, intermediate: 1.35, advanced: 1.95, elite: 2.70},
                    bench: {untrained: 0.30, novice: 0.50, intermediate: 0.95, advanced: 1.40, elite: 1.95},
                    deadlift: {untrained: 0.55, novice: 0.95, intermediate: 1.65, advanced: 2.35, elite: 3.25},
                    ohp: {untrained: 0.20, novice: 0.35, intermediate: 0.65, advanced: 0.95, elite: 1.35},
                    row: {untrained: 0.25, novice: 0.45, intermediate: 0.90, advanced: 1.30, elite: 1.75}
                }
            }
        };

        // Level Colors
        const levelColors = {
            beginner: 'text-gray-400',
            untrained: 'text-blue-400',
            novice: 'text-green-400',
            intermediate: 'text-yellow-400',
            advanced: 'text-orange-400',
            elite: 'text-red-400'
        };

        const levelBgColors = {
            beginner: 'bg-gray-600',
            untrained: 'bg-blue-600',
            novice: 'bg-green-600',
            intermediate: 'bg-yellow-600',
            advanced: 'bg-orange-600',
            elite: 'bg-red-600'
        };
        
        // Calculator Handlers
        function handleCalculateStrength() {
            state.strengthResult = calculateStrength();
            render();
        }
        
        function handleCalculate1RM() {
            state.oneRMResult = calculate1RM();
            render();
        }

        function handleCalculatePlates() {
            state.plateResult = calculatePlates();
            render();
        }

        // Calculate Plates
        function calculatePlates() {
            const target = parseFloat(state.weight);
            if (!target || target <= 0) return null;
            
            const barWeight = bars[state.bar][state.unit];
            if (target <= barWeight) return { error: 'Weight is less than or equal to bar weight' };
            
            const weightToLoad = target - barWeight;
            const perSide = weightToLoad / 2;
            const result = [];
            let remaining = perSide;
            
            for (const plate of plates[state.unit]) {
                const count = Math.floor(remaining / plate);
                if (count > 0) {
                    result.push({ weight: plate, count });
                    remaining -= plate * count;
                }
            }
            
            if (remaining > 0.1) {
                return { 
                    error: `Closest weight: ${(target - remaining * 2).toFixed(1)} ${state.unit}`, 
                    plates: result 
                };
            }
            
            return { plates: result };
        }

        // Calculate 1RM
        function calculate1RM() {
            const weight = parseFloat(state.repWeight);
            const reps = parseInt(state.reps);
            
            if (!weight || !reps || weight <= 0 || reps <= 0 || reps > 12) return null;
            
            if (reps === 1) {
                const percentages = {};
                [95, 90, 85, 80, 75, 70, 65, 60].forEach(pct => {
                    percentages[pct] = (weight * pct / 100).toFixed(1);
                });
                return { avg: weight.toFixed(1), percentages };
            }
            
            const epley = weight * (1 + reps / 30);
            const brzycki = weight * (36 / (37 - reps));
            const avg = (epley + brzycki) / 2;
            
            const percentages = {};
            [95, 90, 85, 80, 75, 70, 65, 60].forEach(pct => {
                percentages[pct] = (avg * pct / 100).toFixed(1);
            });
            
            return { avg: avg.toFixed(1), percentages };
        }

        // Calculate Strength Level
        function calculateStrength() {
            const bodyweight = parseFloat(state.bodyweight);
            const weight = parseFloat(state.strengthWeight);
            
            if (!bodyweight || !weight || bodyweight <= 0 || weight <= 0) return null;
            
            const weightLbs = state.unit === 'kg' ? weight * 2.20462 : weight;
            const bodyweightLbs = state.unit === 'kg' ? bodyweight * 2.20462 : bodyweight;
            const ratio = weightLbs / bodyweightLbs;
            
            const standards = strengthStandards[state.category][state.gender][state.exercise];
            
            let level = 'beginner';
            let progress = 0;
            let nextLevel = 'untrained';
            
            if (ratio >= standards.elite) {
                level = 'elite';
                progress = 100;
                nextLevel = 'elite';
            } else if (ratio >= standards.advanced) {
                level = 'advanced';
                nextLevel = 'elite';
                progress = ((ratio - standards.advanced) / (standards.elite - standards.advanced)) * 100;
            } else if (ratio >= standards.intermediate) {
                level = 'intermediate';
                nextLevel = 'advanced';
                progress = ((ratio - standards.intermediate) / (standards.advanced - standards.intermediate)) * 100;
            } else if (ratio >= standards.novice) {
                level = 'novice';
                nextLevel = 'intermediate';
                progress = ((ratio - standards.novice) / (standards.intermediate - standards.novice)) * 100;
            } else if (ratio >= standards.untrained) {
                level = 'untrained';
                nextLevel = 'novice';
                progress = ((ratio - standards.untrained) / (standards.novice - standards.untrained)) * 100;
            } else {
                level = 'beginner';
                nextLevel = 'untrained';
                progress = (ratio / standards.untrained) * 100;
            }
            
            const nextWeight = standards[nextLevel] ? (standards[nextLevel] * bodyweightLbs) : null;
            const nextWeightConverted = nextWeight ? 
                (state.unit === 'kg' ? (nextWeight / 2.20462).toFixed(1) : nextWeight.toFixed(0)) : null;
            
            return {
                level,
                ratio: ratio.toFixed(2),
                progress: Math.min(progress, 100).toFixed(0),
                nextLevel,
                nextWeight: nextWeightConverted
            };
        }

        // Add Activity
        function addActivity() {
            if (state.logActivityType === 'strength') {
                if (!state.workoutWeight || !state.workoutReps) return;
                
                const numSets = parseInt(state.workoutSets) || 1;
                const sets = [];
                
                for (let i = 0; i < numSets; i++) {
                    sets.push({
                        id: Date.now() + i,
                        type: 'strength',
                        exercise: exercises[state.workoutExercise],
                        weight: parseFloat(state.workoutWeight),
                        reps: parseInt(state.workoutReps),
                        unit: state.unit
                    });
                }
                
                state.currentSets = [...state.currentSets, ...sets];
                state.workoutWeight = '';
                state.workoutReps = '';
                state.workoutSets = '1';
                
            } else { // Cardio
                if (!state.workoutCardioDuration) return;
                
                state.currentSets.push({
                    id: Date.now(),
                    type: 'cardio',
                    exercise: cardioExercises[state.workoutCardioExercise],
                    duration: parseFloat(state.workoutCardioDuration)
                });
                state.workoutCardioDuration = '';
            }
            
            render();
        }

        // Confetti
        function triggerConfetti() {
            const container = document.getElementById('confetti-container');
            if (!container) return;
            const colors = ['#3b82f6', '#a855f7', '#ec4899', '#22c55e', '#facc15'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('span');
                confetti.classList.add('confetti');
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
                
                container.appendChild(confetti);
                
                setTimeout(() => {
                    confetti.remove();
                }, 3000);
            }
        }

        // Helper function for auto-PR check
        function isNewPR(exerciseName, weight, reps) {
            const w = parseFloat(weight);
            const r = parseInt(reps);
            
            if (!w || !r || w <= 0 || r <= 0) return false;
            
            const existingPRs = state.prs.filter(pr => pr.exercise === exerciseName && pr.unit === state.unit);
            
            if (existingPRs.length === 0) return true;

            const maxWeightPR = Math.max(...existingPRs.map(pr => pr.weight));
            
            if (w > maxWeightPR) return true;
            
            if (w === maxWeightPR) {
                const repsAtMaxWeight = Math.max(...existingPRs.filter(pr => pr.weight === maxWeightPR).map(pr => pr.reps));
                if (r > repsAtMaxWeight) return true;
            }
            
            return false;
        }
        
        // Helper to show next PR from queue
        function showNextPR() {
            if (!state.pendingPRs || state.pendingPRs.length === 0) {
                savePendingWorkout();
                return;
            }
            
            const nextPR = state.pendingPRs.shift();
            state.prData = { exercise: nextPR.exercise, weight: nextPR.weight, reps: nextPR.reps };
            state.showPRDialog = true;
            render();
            triggerConfetti();
        }
        
        // Helper to save workout after PRs are handled
        function savePendingWorkout() {
            if (!state.pendingWorkout) return;
            
            state.workouts = [...state.workouts, state.pendingWorkout];
            localStorage.setItem('workouts', JSON.stringify(state.workouts));
            
            state.currentSets = [];
            state.selectedCalendarDate = null;
            state.pendingWorkout = null;
            state.pendingPRs = [];
            
            alert('ðŸŽ‰ Workout saved!');
            render();
        }


        // Finish Workout (with auto-PR check AND de-duplication)
        function finishWorkout() {
            if (state.currentSets.length === 0) return;

            const workoutDate = state.selectedCalendarDate 
                ? new Date(state.selectedCalendarDate + 'T12:00:00') 
                : new Date();
            
            const workout = {
                id: Date.now(),
                date: workoutDate.toISOString(),
                activities: state.currentSets,
                volume: state.currentSets
                    .filter(a => a.type === 'strength')
                    .reduce((sum, set) => {
                        const w = parseFloat(set.weight) || 0;
                        const r = parseInt(set.reps) || 0;
                        return sum + (w * r);
                    }, 0)
            };
            
            // 1. Find all sets that are potentially new PRs
            const potentialPRs = state.currentSets.filter(a => 
                a.type === 'strength' && isNewPR(a.exercise, a.weight, a.reps)
            );
            
            // 2. De-duplicate: Find only the *best* PR for each exercise in this session
            const bestPRsMap = new Map();
            for (const pr of potentialPRs) {
                const key = pr.exercise;
                const existing = bestPRsMap.get(key);
                
                const prWeight = parseFloat(pr.weight);
                const prReps = parseInt(pr.reps);
                
                if (!existing) {
                    bestPRsMap.set(key, pr);
                } else {
                    const existingWeight = parseFloat(existing.weight);
                    const existingReps = parseInt(existing.reps);
                    
                    if (prWeight > existingWeight) {
                        bestPRsMap.set(key, pr); // New weight is higher
                    } else if (prWeight === existingWeight) {
                        if (prReps > existingReps) {
                            bestPRsMap.set(key, pr); // Same weight, more reps
                        }
                    }
                }
            }
            const finalNewPRs = Array.from(bestPRsMap.values());
            
            // 3. Show modals for the de-duplicated list
            if (finalNewPRs.length > 0) {
                state.pendingWorkout = workout;
                state.pendingPRs = finalNewPRs;
                showNextPR();
            } else {
                state.workouts = [...state.workouts, workout];
                localStorage.setItem('workouts', JSON.stringify(state.workouts));
                state.currentSets = [];
                state.selectedCalendarDate = null; 
                alert('ðŸŽ‰ Workout saved!');
                render();
            }
        }

        // Check PR (Manual Button)
        function checkPR(exerciseName, weight, reps) {
            if (isNewPR(exerciseName, weight, reps)) {
                state.prData = { exercise: exerciseName, weight, reps };
                state.showPRDialog = true;
                render();
                triggerConfetti();
            } else {
                alert('Not a new PR (compared to your max weight/rep PR).');
            }
        }

        // --- UPDATED: Share PR function ---
        function sharePR(pr) {
            const hook = `\n\nInterested in documenting your own fitness journey? Check out Rocko's Modern Gym App!`;
            const msg = `âœ¨ðŸ† **PERSONAL RECORD!** ðŸ†âœ¨\n\n${pr.userName || 'I'} hit this PR on ${new Date(pr.date).toLocaleDateString()}:\n\n**${pr.exercise}**\nðŸš€ **${pr.weight} ${pr.unit} Ã— ${pr.reps} reps** ðŸš€\n\nðŸ’ª Crushed it! ðŸ’ª\nTracked with Rocko's Modern Gym App!${hook}`;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(msg)}`, '_blank');
        }


        // Save PR
        function savePR(share) {
            if (!state.prData) return;
            
            const newPR = {
                id: Date.now(),
                userName: state.userName || 'Anonymous',
                exercise: state.prData.exercise,
                weight: state.prData.weight,
                reps: state.prData.reps,
                unit: state.unit,
                date: new Date().toISOString()
            };
            
            state.prs = state.prs.filter(pr => 
                pr.exercise !== newPR.exercise || 
                pr.weight > newPR.weight ||
                (pr.weight === newPR.weight && pr.reps > newPR.reps)
            );
            
            state.prs.push(newPR);
            localStorage.setItem('prs', JSON.stringify(state.prs));
            
            if (share) {
                sharePR(newPR);
            }
            
            state.showPRDialog = false;
            state.prData = null;
            
            if (state.pendingWorkout) {
                showNextPR();
            } else {
                render();
            }
        }

        // Delete PR (Already has confirmation)
        function deletePR(id) {
            if (confirm('Are you sure you want to delete this PR?')) {
                state.prs = state.prs.filter(pr => pr.id !== id);
                localStorage.setItem('prs', JSON.stringify(state.prs));
                render();
            }
        }

        // --- UPDATED: Share Workout function ---
        function shareWorkout(workout) {
            const activities = workout.activities || workout.sets || [];
            
            const activitiesList = activities
                .map(a => {
                    if (a.type === 'strength') {
                        return `    ðŸ‹ï¸â€â™‚ï¸ ${a.exercise}: ${a.weight} ${a.unit} Ã— ${a.reps}`;
                    } else {
                        return `    ðŸƒâ€â™‚ï¸ ${a.exercise}: ${a.duration} min`;
                    }
                })
                .join('\n');
            
            let volumeMsg = '';
            if (workout.volume > 0) {
                volumeMsg = `\n\n---\nðŸ”¥ **Total Volume: ${workout.volume.toLocaleString()} ${state.unit}** ðŸ”¥`;
            }

            const hook = `\n\nInterested in documenting your own fitness journey? Check out Rocko's Modern Gym App!`;
            const msg = `ðŸ’ª **WORKOUT COMPLETE!** ðŸ’ª\n\n${state.userName || 'I'} just finished a session on ${new Date(workout.date).toLocaleDateString()}:\n\n${activitiesList}${volumeMsg}\n\nTracked with Rocko's Modern Gym App! âš¡${hook}`;
            
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(msg)}`, '_blank');
        }

        // Get Streak
        function getStreak() {
            if (state.workouts.length === 0) return 0;
            
            const dates = [...new Set(state.workouts.map(w => new Date(w.date).toDateString()))].sort((a, b) => new Date(b) - new Date(a));
            let streak = 0;
            
            for (let i = 0; i < dates.length; i++) {
                const checkDate = new Date();
                checkDate.setDate(checkDate.getDate() - i);
                if (dates.includes(checkDate.toDateString())) {
                    streak++;
                } else {
                    break;
                }
            }
            
            return streak;
        }

        // Share Streak
        function shareStreak() {
            const streak = getStreak();
            const msg = `ðŸ”¥ðŸ”¥ **${streak} DAY STREAK!** ðŸ”¥ðŸ”¥\n\n${state.userName || 'I'} am on a ${streak} day workout streak!\n\nKeep grinding! ðŸ’ª\nTracked with Rocko's Modern Gym App!`;
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(msg)}`, '_blank');
        }

        // Save User Name
        function saveUserName() {
            localStorage.setItem('userName', state.userName);
            state.showNameDialog = false;
            render();
        }

        // Delete Workout
        function deleteWorkout(id) {
            if (confirm('Are you sure you want to delete this workout?')) {
                state.workouts = state.workouts.filter(w => w.id !== id);
                localStorage.setItem('workouts', JSON.stringify(state.workouts));
                render();
            }
        }

        // Get Progress Data
        function getProgressData(exerciseName) {
            const data = [];
            state.workouts.forEach(wo => {
                const activities = wo.activities || wo.sets || [];
                
                activities.forEach(a => {
                    if (a.type === 'strength' && 
                        a.exercise === exerciseName && 
                        a.weight !== null && a.weight !== undefined && 
                        a.reps !== null && a.reps !== undefined &&
                        parseFloat(a.weight) > 0 && 
                        parseInt(a.reps) > 0) {
                        
                        data.push({
                            date: new Date(wo.date),
                            weight: parseFloat(a.weight),
                            reps: parseInt(a.reps)
                        });
                    }
                });
            });
            return data.sort((a, b) => a.date - b.date);
        }

        // Calendar Functions
        function getDaysInMonth(month, year) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(month, year) {
            return new Date(year, month, 1).getDay();
        }

        function getWorkoutDates() {
            return new Set(state.workouts.map(w => new Date(w.date).toISOString().split('T')[0]));
        }
        
        function getPlanDates() {
            const plans = {};
            for (const date in state.plans) {
                if (state.plans[date] && state.plans[date].length > 0) {
                    const hasStrength = state.plans[date].some(p => p.type === 'strength' || p.type === 'routine');
                    const hasCardio = state.plans[date].some(p => p.type === 'cardio');
                    
                    if (hasStrength) plans[date] = 'strength';
                    else if (hasCardio) plans[date] = 'cardio';
                }
            }
            return plans;
        }

        function changeMonth(delta) {
            state.calendarMonth += delta;
            if (state.calendarMonth > 11) {
                state.calendarMonth = 0;
                state.calendarYear++;
            } else if (state.calendarMonth < 0) {
                state.calendarMonth = 11;
                state.calendarYear--;
            }
            render();
        }
        
        function selectCalendarDay(dateString) {
            state.selectedCalendarDate = dateString;
            state.showCalendarModal = true;
            render();
        }

        function resetPlanForm() {
            state.planType = 'activity';
            state.planActivityType = 'strength';
            state.planStrengthExercise = 'squat';
            state.planCardioExercise = 'run';
            state.planCardioDuration = '';
            state.planNotes = '';
            state.planRoutineId = '';
        }

        function closeCalendarModal() {
            state.showCalendarModal = false;
            state.selectedCalendarDate = null;
            resetPlanForm();
            render();
        }

        function savePlan() {
            let newPlan = {
                id: Date.now(),
                date: state.selectedCalendarDate,
            };

            if (state.planType === 'routine') {
                if (!state.planRoutineId) {
                    alert('Please select a routine.');
                    return;
                }
                const routine = state.routines.find(r => r.id == state.planRoutineId);
                newPlan.type = 'routine';
                newPlan.activityName = routine.name;
                newPlan.details = { routineId: routine.id };

            } else { // 'activity'
                if (state.planActivityType === 'strength') {
                    newPlan.type = 'strength';
                    newPlan.activityName = exercises[state.planStrengthExercise];
                    newPlan.details = { notes: state.planNotes };
                } else { // 'cardio'
                    if (!state.planCardioDuration) {
                        alert('Please enter a duration.');
                        return;
                    }
                    newPlan.type = 'cardio';
                    newPlan.activityName = cardioExercises[state.planCardioExercise];
                    newPlan.details = { duration: state.planCardioDuration };
                }
            }
            
            if (!state.plans[state.selectedCalendarDate]) {
                state.plans[state.selectedCalendarDate] = [];
            }
            state.plans[state.selectedCalendarDate].push(newPlan);
            
            localStorage.setItem('plans', JSON.stringify(state.plans));
            
            resetPlanForm();
            render();
        }

        function deletePlan(planId) {
            const plansForDay = state.plans[state.selectedCalendarDate];
            if (!plansForDay) return;

            state.plans[state.selectedCalendarDate] = plansForDay.filter(p => p.id !== planId);
            
            if (state.plans[state.selectedCalendarDate].length === 0) {
                delete state.plans[state.selectedCalendarDate];
            }
            
            localStorage.setItem('plans', JSON.stringify(state.plans));
            render();
        }
        
        function logForSelectedDate() {
            const plansForDay = state.plans[state.selectedCalendarDate] || [];
            if (plansForDay.length === 0) {
                state.view = 'log';
                state.showCalendarModal = false;
                render();
                return;
            }

            let activitiesToLog = [];
            plansForDay.forEach(plan => {
                if (plan.type === 'routine') {
                    const routine = state.routines.find(r => r.id == plan.details.routineId);
                    if (routine) {
                        routine.activities.forEach(a => {
                            let newActivity = { ...a, id: Date.now() + Math.random() };
                            if (newActivity.type === 'strength') {
                                newActivity.weight = a.weight || '';
                                newActivity.reps = a.reps || '';
                            }
                            activitiesToLog.push(newActivity);
                        });
                    }
                } else if (plan.type === 'strength') {
                    activitiesToLog.push({
                        id: plan.id,
                        type: 'strength',
                        exercise: plan.activityName,
                        weight: '', reps: '', unit: state.unit
                    });
                } else if (plan.type === 'cardio') {
                    activitiesToLog.push({
                        id: plan.id,
                        type: 'cardio',
                        exercise: plan.activityName,
                        duration: plan.details.duration
                    });
                }
            });

            state.currentSets = activitiesToLog;
            state.view = 'log';
            state.showCalendarModal = false;
            render();
        }

        // Routines - Add activity
        function addActivityToRoutine() {
            if (state.routineActivityType === 'strength') {
                if (!state.workoutWeight || !state.workoutReps) return;
                
                const numSets = parseInt(state.workoutSets) || 1;
                for (let i = 0; i < numSets; i++) {
                    state.currentRoutineSets.push({
                        id: Date.now() + i,
                        type: 'strength',
                        exercise: exercises[state.workoutExercise],
                        weight: parseFloat(state.workoutWeight),
                        reps: parseInt(state.workoutReps),
                        unit: state.unit
                    });
                }
                state.workoutWeight = '';
                state.workoutReps = '';
                state.workoutSets = '1';
                
            } else { // Cardio
                if (!state.workoutCardioDuration) return;
                
                state.currentRoutineSets.push({
                    id: Date.now(),
                    type: 'cardio',
                    exercise: cardioExercises[state.workoutCardioExercise],
                    duration: parseFloat(state.workoutCardioDuration)
                });
                state.workoutCardioDuration = '';
            }
            
            render();
        }

        // Routines - Save
        function saveRoutine() {
            if (!state.currentRoutineName) {
                alert('Please enter a routine name.');
                return;
            }
            if (state.currentRoutineSets.length === 0) {
                alert('Please add at least one exercise to the routine.');
                return;
            }

            state.routines.push({
                id: Date.now(),
                name: state.currentRoutineName,
                activities: state.currentRoutineSets
            });
            localStorage.setItem('routines', JSON.stringify(state.routines));
            
            state.currentRoutineName = '';
            state.currentRoutineSets = [];
            alert('Routine saved!');
            render();
        }

        // --- UPDATED: Routines - Delete (with protection) ---
        function deleteRoutine(id) {
            if (id <= 1005) {
                alert('Default routines cannot be deleted.');
                return;
            }
            
            if (confirm('Are you sure you want to delete this routine?')) {
                state.routines = state.routines.filter(r => r.id !== id);
                localStorage.setItem('routines', JSON.stringify(state.routines));
                render();
            }
        }

        // Routines - Load into Log
        function loadRoutine(routineId, clearSelectedDate = true) {
            const routine = state.routines.find(r => r.id == routineId);
            if (!routine) return;

            const activitiesToLog = routine.activities.map(a => {
                let newActivity = { ...a, id: Date.now() + Math.random() };
                if (newActivity.type === 'strength') {
                    newActivity.weight = a.weight || '';
                    newActivity.reps = a.reps || '';
                }
                return newActivity;
            });

            state.currentSets = activitiesToLog;
            if (clearSelectedDate) {
                state.selectedCalendarDate = null;
            }
            state.view = 'log';
            render();
        }

        // Render Calendar
        function renderCalendar() {
            const daysInMonth = getDaysInMonth(state.calendarMonth, state.calendarYear);
            const firstDay = getFirstDayOfMonth(state.calendarMonth, state.calendarYear);
            const workoutDates = getWorkoutDates();
            const planDates = getPlanDates();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            
            let calendarHTML = `
                <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="changeMonth(-1)" class="glass hover:glass-strong px-4 py-2 rounded-lg">â†</button>
                        <h3 class="text-xl font-bold">${monthNames[state.calendarMonth]} ${state.calendarYear}</h3>
                        <button onclick="changeMonth(1)" class="glass hover:glass-strong px-4 py-2 rounded-lg">â†’</button>
                    </div>
                    
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                            `<div class="text-center text-sm text-gray-400 font-semibold">${day}</div>`
                        ).join('')}
                    </div>
                    
                    <div class="grid grid-cols-7 gap-2">
                        ${Array(firstDay).fill(null).map(() => 
                            `<div class="calendar-day"></div>`
                        ).join('')}
                        
                        ${Array(daysInMonth).fill(null).map((_, i) => {
                            const day = i + 1;
                            const date = new Date(state.calendarYear, state.calendarMonth, day);
                            const dateString = date.toISOString().split('T')[0];
                            const hasWorkout = workoutDates.has(dateString);
                            const planType = planDates[dateString];
                            const isToday = new Date().toISOString().split('T')[0] === dateString;
                            
                            let dayClass = 'glass';
                            if (hasWorkout) {
                                dayClass = 'bg-green-600';
                            } else if (planType === 'strength') {
                                dayClass = 'bg-purple-600';
                            } else if (planType === 'cardio') {
                                dayClass = 'bg-blue-600';
                            }
                            
                            return `
                                <div onclick="selectCalendarDay('${dateString}')" 
                                     class="calendar-day rounded-lg ${dayClass} ${isToday ? 'ring-2 ring-blue-400' : ''} hover:glass-strong transition">
                                    <span class="text-sm ${hasWorkout || planType ? 'font-bold' : ''}">${day}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="mt-6 flex flex-wrap items-center justify-center gap-4 text-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-green-600"></div>
                            <span class="text-gray-400">Logged</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-purple-600"></div>
                            <span class="text-gray-400">Planned Strength</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded bg-blue-600"></div>
                            <span class="text-gray-400">Planned Cardio</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 rounded glass"></div>
                            <span class="text-gray-400">Rest Day</span>
                        </div>
                    </div>
                </div>
            `;
            
            return calendarHTML;
        }

        // Safe state change handlers for modal
        function handlePlanTypeChange(type) {
            state.planType = type;
            render();
        }
        function handlePlanActivityTypeChange(type) {
            state.planActivityType = type;
            render();
        }

        // Chart Rendering
        let chartInstances = {};

        function renderCharts() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};

            if (state.view !== 'prog' || !window.Chart) return;

            const chartType = state.progressChartType;
            let yAxisLabel = 'Weight';
            if (chartType === 'volume') yAxisLabel = 'Volume (Weight x Reps)';
            if (chartType === '1rm') yAxisLabel = 'Est. 1RM';

            Object.entries(exercises).forEach(([key, name]) => {
                const data = getProgressData(name);
                if (data.length === 0) return;

                const canvas = document.getElementById(`chart-${key}`);
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                const chartData = data.map(entry => {
                    let yValue;
                    switch(chartType) {
                        case 'volume':
                            yValue = entry.weight * entry.reps;
                            break;
                        case '1rm':
                            yValue = entry.weight * (1 + entry.reps / 30); // Epley
                            break;
                        default:
                            yValue = entry.weight;
                    }
                    return { x: entry.date.getTime(), y: yValue, reps: entry.reps };
                });

                chartInstances[key] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: `${name} (${yAxisLabel})`,
                            data: chartData,
                            borderColor: 'rgba(59, 130, 246, 0.8)',
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            borderWidth: 2,
                            tension: 0.1,
                            pointRadius: (ctx) => ctx.raw.reps ? Math.max(3, ctx.raw.reps / 2) : 3,
                            pointBackgroundColor: 'rgba(59, 130, 246, 0.8)',
                            pointHoverRadius: (ctx) => ctx.raw.reps ? Math.max(5, ctx.raw.reps / 1.5) : 5,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'day',
                                    tooltipFormat: 'PP'
                                },
                                adapters: {
                                    date: {
                                        locale: 'enUS'
                                    }
                                },
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.7)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                title: {
                                    display: true,
                                    text: `${yAxisLabel} (${state.unit})`,
                                    color: 'rgba(255, 255, 255, 0.7)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: (context) => new Date(context[0].raw.x).toLocaleDateString(),
                                    label: (context) => {
                                        let label = `${yAxisLabel}: ${context.raw.y.toFixed(1)} ${state.unit}`;
                                        if (context.raw.reps) {
                                            label += ` (Reps: ${context.raw.reps})`;
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            });
        }


        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            const streak = getStreak();

            function renderActivity(a, idx, listName) {
                if (listName === 'currentSets') {
                    if (a.type === 'strength') {
                        return `
                            <div class="glass-strong rounded-lg p-3 mb-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold">${a.exercise}</span>
                                    <button onclick="state.currentSets.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" value="${a.weight}" oninput="state.currentSets[${idx}].weight = this.value" placeholder="Weight (${a.unit})" class="glass text-white rounded-lg px-3 py-2 text-sm">
                                    <input type="number" value="${a.reps}" oninput="state.currentSets[${idx}].reps = this.value" placeholder="Reps" class="glass text-white rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="glass-strong rounded-lg p-3 mb-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold">${a.exercise}</span>
                                    <button onclick="state.currentSets.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                                </div>
                                <input type="number" value="${a.duration}" oninput="state.currentSets[${idx}].duration = this.value" placeholder="Duration (min)" class="w-full glass text-white rounded-lg px-3 py-2 text-sm">
                            </div>
                        `;
                    }
                } else {
                    if (a.type === 'strength') {
                        return `
                            <div class="flex items-center justify-between glass-strong rounded-lg p-3 mb-2">
                                <div>
                                    <span class="font-semibold">${a.exercise}</span>
                                    <span class="text-gray-400 ml-2">${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</span>
                                </div>
                                <button onclick="state.${listName}.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="flex items-center justify-between glass-strong rounded-lg p-3 mb-2">
                                <div>
                                    <span class="font-semibold">${a.exercise}</span>
                                    <span class="text-gray-400 ml-2">${a.duration} min</span>
                                </div>
                                <button onclick="state.${listName}.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                            </div>
                        `;
                    }
                }
            }

            app.innerHTML = `
                <div class="text-center mb-6 pt-6">
                    <div class="flex items-center justify-center gap-3 mb-2">
                        <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        <h1 class="text-4xl font-bold">Rocko's Modern Gym App</h1>
                    </div>
                    <p class="text-gray-400">Your complete strength training companion</p>
                    ${state.userName ? 
                        `<button onclick="state.showNameDialog = true; render();" class="text-gray-400 hover:text-white text-sm mt-2">ðŸ‘¤ ${state.userName}</button>` :
                        `<button onclick="state.showNameDialog = true; render();" class="glass hover:glass-strong px-4 py-2 rounded-lg text-sm mt-2">ðŸ‘¤ Set Your Name</button>`
                    }
                </div>

                <div class="grid grid-cols-6 gap-2 mb-6 glass-strong p-2 rounded-xl">
                    <button onclick="state.view = 'calc'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'calc' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                        <span>ðŸ’ª</span>
                        <span class="text-xs">Calc</span>
                    </button>
                    <button onclick="state.view = 'log'; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'log' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                        <span>ðŸ“</span>
                        <span class="text-xs">Log</span>
                    </button>
                    <button onclick="state.view = 'cal'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'cal' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                        <span>ðŸ“…</span>
                        <span class="text-xs">Calendar</span>
                    </button>
                    <button onclick="state.view = 'routines'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'routines' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                        <span>ðŸ““</span>
                        <span class="text-xs">Routines</span>
                    </button>
                    <button onclick="state.view = 'prog'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'prog' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                        <span>ðŸ“ˆ</span>
                        <span class="text-xs">Progress</span>
                    </button>
                    <button onclick="state.view = 'prs'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'prs' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                        <span>ðŸ†</span>
                        <span class="text-xs">PRs</span>
                    </button>
                </div>

                ${streak > 0 ? `
                    <div class="bg-gradient-to-r from-orange-600 to-red-600 rounded-xl p-4 mb-6 flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">ðŸ”¥</span>
                            <span class="text-2xl font-bold">${streak} Day Streak!</span>
                        </div>
                        <button onclick="shareStreak()" class="text-3xl hover:scale-110 transition">ðŸ“¤</button>
                    </div>
                ` : ''}

                ${state.view === 'calc' ? `
                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                        <h3 class="text-xl font-bold mb-4">Strength Standards</h3>
                        
                        <div class="flex gap-2 mb-4">
                            <button onclick="state.unit = 'lbs'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'lbs' ? 'bg-blue-600' : 'glass hover:glass-strong'}">LBS</button>
                            <button onclick="state.unit = 'kg'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'kg' ? 'bg-blue-600' : 'glass hover:glass-strong'}">KG</button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <select onchange="state.exercise = this.value; render();" class="glass text-white rounded-lg px-4 py-3">
                                ${['squat', 'bench', 'deadlift', 'ohp', 'row'].map(ex => 
                                    `<option value="${ex}" ${state.exercise === ex ? 'selected' : ''}>${exercises[ex]}</option>`
                                ).join('')}
                            </select>
                            <select onchange="state.gender = this.value; render();" class="glass text-white rounded-lg px-4 py-3">
                                <option value="male" ${state.gender === 'male' ? 'selected' : ''}>Male</option>
                                <option value="female" ${state.gender === 'female' ? 'selected' : ''}>Female</option>
                            </select>
                        </div>
                        
                        <select onchange="state.category = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            <option value="natural" ${state.category === 'natural' ? 'selected' : ''}>Natural Lifter</option>
                            <option value="enhanced" ${state.category === 'enhanced' ? 'selected' : ''}>Enhanced Lifter</option>
                        </select>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input type="number" value="${state.bodyweight}" oninput="state.bodyweight = this.value;" placeholder="Your bodyweight (${state.unit})" class="w-full glass text-white rounded-lg px-4 py-3">
                            <input type="number" value="${state.strengthWeight}" oninput="state.strengthWeight = this.value;" placeholder="Weight Lifted (${state.unit})" class="w-full glass text-white rounded-lg px-4 py-3">
                        </div>
                        
                        <button onclick="handleCalculateStrength()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">
                            Calculate Strength
                        </button>
                        
                        ${state.strengthResult ? `
                            <div class="glass rounded-xl p-6">
                                <div class="text-center mb-4">
                                    <div class="text-3xl font-bold ${levelColors[state.strengthResult.level]} capitalize mb-2">${state.strengthResult.level}</div>
                                    <div class="text-gray-400 text-sm">${state.strengthResult.ratio}x Bodyweight</div>
                                </div>
                                
                                ${state.strengthResult.level !== 'elite' ? `
                                    <div class="mb-4">
                                        <div class="flex justify-between text-xs text-gray-400 mb-2">
                                            <span>Progress to ${state.strengthResult.nextLevel}</span>
                                            <span>${state.strengthResult.progress}%</span>
                                        </div>
                                        <div class="w-full glass rounded-full h-3">
                                            <div class="h-3 rounded-full ${levelBgColors[state.strengthResult.level]} transition-all duration-500" style="width: ${state.strengthResult.progress}%"></div>
                                        </div>
                                    </div>
                                    ${state.strengthResult.nextWeight ? `
                                        <div class="text-center text-sm">
                                            <span class="text-gray-400">Next milestone:</span>
                                            <span class="text-white font-bold text-lg ml-2">${state.strengthResult.nextWeight} ${state.unit}</span>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <div class="text-center text-green-400 font-semibold">ðŸ† Maximum Level Achieved!</div>
                                `}
                            </div>
                        ` : ''}
                    </div>

                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                        <h3 class="text-xl font-bold mb-4">1RM Calculator</h3>
                        
                        <div class="flex gap-2 mb-4">
                            <button onclick="state.unit = 'lbs'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'lbs' ? 'bg-blue-600' : 'glass hover:glass-strong'}">LBS</button>
                            <button onclick="state.unit = 'kg'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'kg' ? 'bg-blue-600' : 'glass hover:glass-strong'}">KG</button>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <input type="number" value="${state.repWeight}" oninput="state.repWeight = this.value;" placeholder="Weight (${state.unit})" class="glass text-white rounded-lg px-4 py-3">
                            <input type="number" value="${state.reps}" oninput="state.reps = this.value;" placeholder="Reps (1-12)" class="glass text-white rounded-lg px-4 py-3">
                        </div>
                        
                        <button onclick="handleCalculate1RM()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">
                            Calculate 1RM
                        </button>
                        
                        ${state.oneRMResult ? `
                            <div class="glass rounded-xl p-6">
                                <div class="text-center mb-6">
                                    <div class="text-sm text-gray-400 mb-2">Estimated 1 Rep Max</div>
                                    <div class="text-5xl font-bold text-green-400">${state.oneRMResult.avg}</div>
                                    <div class="text-sm text-gray-400 mt-1">${state.unit}</div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3">
                                    ${[95, 90, 85, 80, 75, 70, 65, 60].map(pct => `
                                        <div class="glass-strong rounded-lg px-4 py-3 flex justify-between items-center">
                                            <span class="text-gray-400 font-semibold">${pct}%</span>
                                            <span class="text-white font-bold">${state.oneRMResult.percentages[pct]}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="text-center text-gray-400 py-6">
                                Enter weight and reps (1-12) to calculate your 1RM
                            </div>
                        `}
                    </div>

                    <div class="glass-strong rounded-2xl shadow-2xl p-6">
                        <h3 class="text-xl font-bold mb-4">Plate Calculator</h3>
                        
                        <div class="flex gap-2 mb-6">
                            <button onclick="state.unit = 'lbs'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'lbs' ? 'bg-blue-600' : 'glass hover:glass-strong'}">LBS</button>
                            <button onclick="state.unit = 'kg'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'kg' ? 'bg-blue-600' : 'glass hover:glass-strong'}">KG</button>
                        </div>
                        
                        <select onchange="state.bar = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-6">
                            ${Object.entries(barNames).map(([key, name]) => 
                                `<option value="${key}" ${state.bar === key ? 'selected' : ''}>${name}</option>`
                            ).join('')}
                        </select>
                        
                        <input type="number" value="${state.weight}" oninput="state.weight = this.value;" placeholder="Enter target weight (${state.unit})" class="w-full glass text-white text-2xl rounded-lg px-4 py-3 mb-6">
                        
                        <button onclick="handleCalculatePlates()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">
                            Calculate Plates
                        </button>
                        
                        ${state.plateResult && state.plateResult.plates ? `
                            <div class="glass rounded-xl p-6">
                                ${state.plateResult.error ? `
                                    <p class="text-yellow-400 text-sm mb-4 text-center font-semibold">${state.plateResult.error}</p>
                                ` : ''}
                                <h4 class="text-xl font-bold mb-4 text-center">Load per side:</h4>
                                <div class="space-y-3">
                                    ${state.plateResult.plates.map(p => `
                                        <div class="flex items-center justify-between glass-strong rounded-xl p-4 hover-scale transition-all">
                                            <span class="text-2xl font-bold text-blue-400">${p.weight} ${state.unit}</span>
                                            <span class="text-xl text-gray-300">Ã— ${p.count}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : state.plateResult && state.plateResult.error ? `
                            <div class="glass rounded-xl p-6 text-center">
                                <p class="text-yellow-400">${state.plateResult.error}</p>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}

                ${state.view === 'log' ? `
                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                        
                        ${state.selectedCalendarDate ?
                            `<div class="bg-yellow-600 text-black text-center font-bold p-3 rounded-lg mb-4 flex justify-between items-center">
                                <span>Logging for: ${new Date(state.selectedCalendarDate + 'T12:00:00').toLocaleDateString()}</span>
                                <button onclick="state.selectedCalendarDate = null; render();" class="text-sm bg-black/20 px-2 py-1 rounded hover:bg-black/40">Log for Today</button>
                            </div>` :
                            `<h3 class="text-xl font-bold mb-4">Log Workout</h3>`
                        }
                        
                        ${state.routines.length > 0 ? `
                            <select onchange="if (this.value) loadRoutine(this.value);" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                <option value="">--- Load a Saved Routine ---</option>
                                ${state.routines.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        ` : ''}

                        ${state.currentSets.length > 0 ? `
                            <div class="mb-6 glass rounded-xl p-4">
                                <h4 class="font-semibold mb-3 text-green-400">Current Workout</h4>
                                ${state.currentSets.map((a, idx) => renderActivity(a, idx, 'currentSets')).join('')}
                                
                                <button onclick="finishWorkout()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green py-3 rounded-lg font-semibold mt-3 transition">
                                    âœ… Finish Workout
                                </button>
                            </div>
                        ` : ''}
                        
                        <div class="flex gap-2 mb-4">
                            <button onclick="state.logActivityType = 'strength'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.logActivityType === 'strength' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸ‹ï¸â€â™‚ï¸ Strength</button>
                            <button onclick="state.logActivityType = 'cardio'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.logActivityType === 'cardio' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸƒâ€â™‚ï¸ Cardio</button>
                        </div>

                        ${state.logActivityType === 'strength' ? `
                            <select onchange="state.workoutExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                ${Object.entries(exercises).map(([key, name]) => 
                                    `<option value="${key}" ${state.workoutExercise === key ? 'selected' : ''}>${name}</option>`
                                ).join('')}
                            </select>
                            
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <input type="number" value="${state.workoutWeight}" oninput="state.workoutWeight = this.value" placeholder="Weight" class="glass text-white rounded-lg px-4 py-3">
                                <input type="number" value="${state.workoutReps}" oninput="state.workoutReps = this.value" placeholder="Reps" class="glass text-white rounded-lg px-4 py-3">
                                <input type="number" value="${state.workoutSets}" oninput="state.workoutSets = this.value" placeholder="Sets" class="glass text-white rounded-lg px-4 py-3">
                            </div>
                        ` : `
                            <select onchange="state.workoutCardioExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                ${Object.entries(cardioExercises).map(([key, name]) => 
                                    `<option value="${key}" ${state.workoutCardioExercise === key ? 'selected' : ''}>${name}</option>`
                                ).join('')}
                            </select>
                            
                            <input type="number" value="${state.workoutCardioDuration}" oninput="state.workoutCardioDuration = this.value" placeholder="Duration (minutes)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                        `}
                        
                        <button onclick="addActivity()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                            âž• Add Activity
                        </button>
                    </div>

                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                        <h3 class="text-xl font-bold mb-4">Recent Workouts</h3>
                        ${state.workouts.length === 0 ? `
                            <div class="text-center py-12">
                                <p class="text-gray-400 text-lg mb-2">No workouts logged yet!</p>
                                <p class="text-gray-500 text-sm">Start tracking your progress above</p>
                            </div>
                        ` : state.workouts.slice().reverse().slice(0, 10).map(w => {
                            const activities = w.activities || w.sets || [];
                            
                            return `
                            <div class="glass rounded-xl p-4 hover-scale transition-all mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-semibold text-lg">${new Date(w.date).toLocaleDateString()}</div>
                                        <div class="text-sm text-gray-400">${activities.length} activities
                                            ${w.volume > 0 ? ` â€¢ ${w.volume.toLocaleString()} ${state.unit} total volume` : ''}
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick='shareWorkout(${JSON.stringify(w).replace(/'/g, "\\'")}); event.stopPropagation();' class="text-blue-400 text-2xl hover:scale-110 transition">ðŸ“¤</button>
                                        <button onclick="deleteWorkout(${w.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    ${activities.map(a => {
                                        if (a.type === 'strength') {
                                            const safeExerciseName = a.exercise ? a.exercise.replace(/'/g, "\\'") : '';
                                            const prButton = (a.weight && a.reps && parseFloat(a.weight) > 0 && parseInt(a.reps) > 0) ?
                                                `<button onclick='checkPR("${safeExerciseName}", ${a.weight}, ${a.reps}); event.stopPropagation();' class="text-xs bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green px-3 py-1 rounded font-semibold transition">
                                                    PR?
                                                </button>` : '';

                                            return `
                                                <div class="flex justify-between items-center glass-strong rounded px-3 py-2">
                                                    <span class="text-sm text-gray-300">${a.exercise}: ${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</span>
                                                    ${prButton}
                                                </div>
                                            `;
                                        } else {
                                            return `
                                                <div class="flex justify-between items-center glass-strong rounded px-3 py-2">
                                                    <span class="text-sm text-gray-300">${a.exercise}: ${a.duration} min</span>
                                                </div>
                                            `;
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                    ` : ''}

                ${state.view === 'cal' ? renderCalendar() : ''}

                ${state.view === 'routines' ? `
                    <div class="space-y-6">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                            <h3 class="text-xl font-bold mb-4">Create New Routine</h3>
                            
                            <input type="text" value="${state.currentRoutineName}" oninput="state.currentRoutineName = this.value" placeholder="Routine Name (e.g., Leg Day)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            
                            ${state.currentRoutineSets.length > 0 ? `
                                <div class="mb-4 glass rounded-xl p-4">
                                    <h4 class="font-semibold mb-3 text-green-400">Exercises in this routine</h4>
                                    ${state.currentRoutineSets.map((a, idx) => renderActivity(a, idx, 'currentRoutineSets')).join('')}
                                </div>
                            ` : ''}

                            <div class="flex gap-2 mb-4">
                                <button onclick="state.routineActivityType = 'strength'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.routineActivityType === 'strength' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸ‹ï¸â€â™‚ï¸ Strength</button>
                                <button onclick="state.routineActivityType = 'cardio'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.routineActivityType === 'cardio' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸƒâ€â™‚ï¸ Cardio</button>
                            </div>

                            ${state.routineActivityType === 'strength' ? `
                                <select onchange="state.workoutExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                    ${Object.entries(exercises).map(([key, name]) => 
                                        `<option value="${key}" ${state.workoutExercise === key ? 'selected' : ''}>${name}</option>`
                                    ).join('')}
                                </select>
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <input type="number" value="${state.workoutWeight}" oninput="state.workoutWeight = this.value" placeholder="Weight" class="glass text-white rounded-lg px-4 py-3">
                                    <input type="number" value="${state.workoutReps}" oninput="state.workoutReps = this.value" placeholder="Reps" class="glass text-white rounded-lg px-4 py-3">
                                    <input type="number" value="${state.workoutSets}" oninput="state.workoutSets = this.value" placeholder="Sets" class="glass text-white rounded-lg px-4 py-3">
                                </div>
                            ` : `
                                <select onchange="state.workoutCardioExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                    ${Object.entries(cardioExercises).map(([key, name]) => 
                                        `<option value="${key}" ${state.workoutCardioExercise === key ? 'selected' : ''}>${name}</option>`
                                    ).join('')}
                                </select>
                                <input type="number" value="${state.workoutCardioDuration}" oninput="state.workoutCardioDuration = this.value" placeholder="Duration (minutes)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            `}
                            
                            <button onclick="addActivityToRoutine()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-3">
                                âž• Add to Routine
                            </button>
                            <button onclick="saveRoutine()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green py-3 rounded-lg font-semibold transition">
                                âœ… Save Routine
                            </button>
                        </div>

                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                            <h3 class="text-xl font-bold mb-4">Saved Routines</h3>
                            ${state.routines.length === 0 ? `
                                <div class="text-center py-12">
                                    <p class="text-gray-400 text-lg mb-2">No routines saved yet!</p>
                                    <p class="text-gray-500 text-sm">Create a new routine above</p>
                                </div>
                            ` : `
                                <div class="space-y-4">
                                    ${state.routines.map(r => `
                                        <div class="glass rounded-xl p-4">
                                            <div class="flex justify-between items-center mb-3">
                                                <span class="font-semibold text-lg text-purple-400">${r.name}</span>
                                                ${r.id > 1005 ? `
                                                    <button onclick="deleteRoutine(${r.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>
                                                ` : ''}
                                            </div>
                                            <div class="space-y-2">
                                                ${r.activities.map(a => {
                                                    if (a.type === 'strength') {
                                                        return `<div class="text-sm glass-strong rounded px-3 py-2">${a.exercise}: ${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</div>`;
                                                    } else {
                                                        return `<div class="text-sm glass-strong rounded px-3 py-2">${a.exercise}: ${a.duration} min</div>`;
                                                    }
                                                }).join('')}
                                            </div>
                                            <button onclick="loadRoutine(${r.id})" class="w-full mt-3 btn-primary hover-scale transition-all ripple py-2 rounded-lg font-semibold text-sm transition">
                                                Start this Workout
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                ` : ''}

                ${state.view === 'prog' ? `
                    <div class="space-y-6">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                            <h3 class="text-xl font-bold mb-4">Progress Visualizer</h3>
                            <select onchange="state.progressChartType = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                <option value="weight" ${state.progressChartType === 'weight' ? 'selected' : ''}>Show Weight Over Time</option>
                                <option value="volume" ${state.progressChartType === 'volume' ? 'selected' : ''}>Show Volume Over Time</option>
                                <option value="1rm" ${state.progressChartType === '1rm' ? 'selected' : ''}>Show Est. 1RM Over Time</option>
                            </select>
                            <p class="text-xs text-gray-400 text-center">Larger dots on the graph represent sets with higher reps.</p>
                        </div>

                        ${Object.entries(exercises).map(([key, name]) => {
                            const data = getProgressData(name);
                            if (data.length === 0) return '';
                            
                            return `
                                <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                                    <h3 class="text-xl font-bold mb-4">${name}</h3>
                                    
                                    <div class="glass rounded-xl p-4 hover-scale transition-all">
                                        <canvas id="chart-${key}"></canvas>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        
                        ${state.workouts.length === 0 ? `
                            <div class="glass-strong rounded-3xl p-6 hover-lift fade-in text-center">
                                <p class="text-gray-400 text-lg mb-2">No progress data yet!</p>
                                <p class="text-gray-500 text-sm">Start logging workouts to track your gains</p>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}

                ${state.view === 'prs' ? `
                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                        <h3 class="text-xl font-bold mb-4">ðŸ† Personal Records</h3>
                        ${state.prs.length === 0 ? `
                            <div class="text-center py-12">
                                <p class="text-gray-400 text-lg mb-2">No PRs logged yet!</p>
                                <p class="text-gray-500 text-sm">Log a workout and use the "PR?" button to save your bests.</p>
                            </div>
                        ` : `
                            <div class="space-y-4">
                                ${state.prs.slice().reverse().map(pr => `
                                    <div class="glass rounded-xl p-4 hover-scale transition-all">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="font-bold text-lg text-green-400">${pr.exercise}</div>
                                                <div class="text-3xl font-bold text-blue-400 my-1">
                                                    ${pr.weight} ${pr.unit} 
                                                    ${pr.reps ? `<span class="text-2xl text-gray-400">Ã— ${pr.reps}</span>` : ''}
                                                </div>
                                                <div class="text-xs text-gray-500">${new Date(pr.date).toLocaleDateString()}</div>
                                            </div>
                                            <div class="flex flex-col items-end gap-2">
                                                <button onclick='sharePR(${JSON.stringify(pr).replace(/'/g, "\\'")})' class="text-blue-400 text-2xl hover:scale-110 transition">ðŸ“¤</button>
                                                <button onclick="deletePR(${pr.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                    ` : ''}

                ${state.showNameDialog ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full">
                            <h3 class="text-xl font-bold mb-4">Set Your Name</h3>
                            <input type="text" value="${state.userName}" oninput="state.userName = this.value" placeholder="Enter your name" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            <div class="flex gap-3">
                                <button onclick="state.showNameDialog = false; render();" class="flex-1 glass hover:glass-strong py-3 rounded-lg transition">Cancel</button>
                                <button onclick="saveUserName()" class="flex-1 btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">Save</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${state.showPRDialog && state.prData ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full">
                            <h3 class="text-2xl font-bold mb-4 text-center gradient-text">Grats! New PR!</h3>
                            <div class="text-center mb-4">
                                <div class="text-lg font-bold text-green-400 mb-2">${state.prData.exercise}</div>
                                <div class="text-4xl font-bold text-blue-400 mb-1">${state.prData.weight} ${state.unit}</div>
                                <div class="text-gray-400">Ã— ${state.prData.reps} reps</div>
                            </div>
                            <p class="text-gray-400 text-sm text-center mb-6">Would you like to share this PR?</p>
                            <div class="flex gap-3">
                                <button onclick="savePR(false)" class="flex-1 glass hover:glass-strong py-3 rounded-lg font-semibold transition">Just Save</button>
                                <button onclick="savePR(true)" class="flex-1 btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition">
                                    ðŸ“¤ Share
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${state.showCalendarModal && state.selectedCalendarDate ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onclick="closeCalendarModal()">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Details for ${new Date(state.selectedCalendarDate + 'T12:00:00').toLocaleDateString()}</h3>
                                <button onclick="closeCalendarModal()" class="text-2xl text-gray-400 hover:text-white">&times;</button>
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-semibold mb-3 text-purple-400">ðŸ—“ï¸ Planned for this Day</h4>
                                ${state.plans[state.selectedCalendarDate] && state.plans[state.selectedCalendarDate].length > 0 ?
                                    state.plans[state.selectedCalendarDate].map(plan => `
                                        <div class="glass rounded-lg p-3 mb-2 flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold">${plan.activityName}</div>
                                                <div class="text-sm text-gray-400">
                                                    ${plan.type === 'routine' ? 'Routine' :
                                                      plan.type === 'strength' ? (plan.details.notes || 'Strength') :
                                                      `${plan.details.duration} min Cardio`}
                                                </div>
                                            </div>
                                            <button onclick="deletePlan(${plan.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>
                                        </div>
                                    `).join('') :
                                    '<p class="text-gray-500 text-sm">No activities planned for this day.</p>'
                                }
                            </div>
                            
                            <div class="mb-4">
                                <h4 class="font-semibold mb-3 text-green-400">âœ… Logged Workouts</h4>
                                ${state.workouts.filter(w => new Date(w.date).toISOString().split('T')[0] === state.selectedCalendarDate).flatMap(w => (w.activities || w.sets || [])).length > 0 ? 
                                    state.workouts.filter(w => new Date(w.date).toISOString().split('T')[0] === state.selectedCalendarDate).map(w => {
                                        const activities = w.activities || w.sets || [];
                                        return `
                                        <div class="glass rounded-lg p-3 mb-2">
                                            <div class="text-sm text-gray-400 mb-2">${activities.length} activities
                                                ${w.volume > 0 ? ` â€¢ ${w.volume.toLocaleString()} ${state.unit} vol` : ''}
                                            </div>
                                            ${activities.map(a => {
                                                if (a.type === 'strength') {
                                                    return `<div class="text-sm glass-strong rounded p-2 mb-1">${a.exercise}: ${a.weight} ${a.unit} Ã— ${a.reps}</div>`;
                                                } else {
                                                    return `<div class="text-sm glass-strong rounded p-2 mb-1">${a.exercise}: ${a.duration} min</div>`;
                                                }
                                            }).join('')}
                                        </div>
                                    `}).join('') : 
                                    '<p class="text-gray-500 text-sm">No workouts logged for this day.</p>'
                                }
                            </div>
                            
                            <div class="mb-6 pt-4 border-t border-white/10">
                                <h4 class="font-semibold mb-3 text-purple-400">âž• Plan New Activity</h4>
                                
                                <div class="flex gap-2 mb-4">
                                    <button onclick="handlePlanTypeChange('activity')" class="flex-1 py-2 rounded-lg font-semibold text-sm transition ${state.planType === 'activity' ? 'bg-purple-600' : 'glass hover:glass-strong'}">Plan Activity</button>
                                    <button onclick="handlePlanTypeChange('routine')" class="flex-1 py-2 rounded-lg font-semibold text-sm transition ${state.planType === 'routine' ? 'bg-purple-600' : 'glass hover:glass-strong'}">Plan Routine</button>
                                </div>

                                ${state.planType === 'activity' ? `
                                    <div class="flex gap-2 mb-4">
                                        <button onclick="handlePlanActivityTypeChange('strength')" class="flex-1 py-2 rounded-lg font-semibold text-xs transition ${state.planActivityType === 'strength' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸ‹ï¸â€â™‚ï¸ Strength</button>
                                        <button onclick="handlePlanActivityTypeChange('cardio')" class="flex-1 py-2 rounded-lg font-semibold text-xs transition ${state.planActivityType === 'cardio' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸƒâ€â™‚ï¸ Cardio</button>
                                    </div>

                                    ${state.planActivityType === 'strength' ? `
                                        <select onchange="state.planStrengthExercise = this.value" class="w-full glass text-white rounded-lg px-4 py-3 mb-2">
                                            ${Object.entries(exercises).map(([key, name]) => 
                                                `<option value="${key}" ${state.planStrengthExercise === key ? 'selected' : ''}>${name}</option>`
                                            ).join('')}
                                        </select>
                                        <input type="text" value="${state.planNotes}" oninput="state.planNotes = this.value" placeholder="Notes (e.g., 5x5)" class="w-full glass text-white rounded-lg px-4 py-3 mb-3">
                                    ` : `
                                        <select onchange="state.planCardioExercise = this.value" class="w-full glass text-white rounded-lg px-4 py-3 mb-2">
                                            ${Object.entries(cardioExercises).map(([key, name]) => 
                                                `<option value="${key}" ${state.planCardioExercise === key ? 'selected' : ''}>${name}</option>`
                                            ).join('')}
                                        </select>
                                        <input type="number" value="${state.planCardioDuration}" oninput="state.planCardioDuration = this.value" placeholder="Duration (minutes)" class="w-full glass text-white rounded-lg px-4 py-3 mb-3">
                                    `}
                                ` : `
                                    <select onchange="state.planRoutineId = this.value" class="w-full glass text-white rounded-lg px-4 py-3 mb-3">
                                        <option value="">--- Select a Routine ---</option>
                                        ${state.routines.map(r => `<option value="${r.id}" ${state.planRoutineId == r.id ? 'selected' : ''}>${r.name}</option>`).join('')}
                                    </select>
                                `}

                                <button onclick="savePlan()" class="w-full bg-purple-600 hover:bg-purple-700 hover-scale transition-all ripple py-2 rounded-lg font-semibold transition">
                                    Add Plan to Day
                                </button>
                            </div>
                            
                            <button onclick="logForSelectedDate()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                                ðŸ“ Log All Activities for this Day
                            </button>
                        </div>
                    </div>
                ` : ''}
            `;

            setTimeout(renderCharts, 0);
        }

        // Initial render
        render();

        // PWA Install Prompt
        let deferredPrompt;
        const installPromptShown = localStorage.getItem('installPromptShown');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!installPromptShown) {
                showInstallPrompt();
            }
        });

        function showInstallPrompt() {
            const promptHTML = `
                <div class="install-prompt bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-4 rounded-2xl shadow-2xl max-w-md mx-4">
                    <div class="flex items-center justify-between gap-4">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">ðŸ’ª</span>
                            <div>
                                <div class="font-bold">Install Rocko's Gym</div>
                                <div class="text-sm opacity-90">Add to your home screen</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="dismissInstallPrompt()" class="px-3 py-2 bg-white/20 rounded-lg text-sm hover:bg-white/30 transition">
                                Later
                            </button>
                            <button onclick="installApp()" class="px-4 py-2 bg-white text-blue-600 rounded-lg text-sm font-semibold hover:bg-gray-100 transition">
                                Install
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            const promptDiv = document.createElement('div');
            promptDiv.innerHTML = promptHTML;
            promptDiv.id = 'install-prompt';
            document.body.appendChild(promptDiv);
        }

        window.installApp = async function() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response: ${outcome}`);
                deferredPrompt = null;
            }
            dismissInstallPrompt();
        };

        window.dismissInstallPrompt = function() {
            const prompt = document.getElementById('install-prompt');
            if (prompt) {
                prompt.remove();
            }
            localStorage.setItem('installPromptShown', 'true');
        };

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed'));
            });
        }

        // iOS Install Instructions
        function isIOS() {
            return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        }

        function isInStandaloneMode() {
            return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
        }

        if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('iosPromptShown')) {
            setTimeout(() => {
                if (confirm('ðŸ’ª Install Rocko\'s Gym App!\n\nTap the Share button (â¬†ï¸) and then "Add to Home Screen" to install.')) {
                    localStorage.setItem('iosPromptShown', 'true');
                }
            }, 3000);
        }
    </script>
</body>
</html>
