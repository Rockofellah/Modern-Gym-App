<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rocko's Modern Gym App</title>
    
    <meta name="description" content="Your complete strength training companion - track workouts, calculate plates, and monitor progress">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rocko's Gym">
    <link rel="manifest" href="manifest.json">
    
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸ’ª%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3EðŸ’ª%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: #0a0e27;
            overflow-x: hidden;
        }
        
        .bg-animated {
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 25%, #0a0e27 50%, #2d1b4e 75%, #0a0e27 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 12px 48px 0 rgba(0, 0, 0, 0.5);
        }
        
        .glow-blue { box-shadow: 0 0 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3); }
        .glow-purple { box-shadow: 0 0 30px rgba(168, 85, 247, 0.5), 0 0 60px rgba(168, 85, 247, 0.3); }
        .glow-green { box-shadow: 0 0 30px rgba(34, 197, 94, 0.5), 0 0 60px rgba(34, 197, 94, 0.3); }
        .glow-gold { box-shadow: 0 0 30px rgba(250, 204, 21, 0.5), 0 0 60px rgba(250, 204, 21, 0.3); }
        
        .hover-lift { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .hover-lift:hover { transform: translateY(-4px); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); }
        .hover-scale:hover { transform: scale(1.02); }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
        
        .calendar-day {
            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            cursor: pointer; position: relative; overflow: hidden;
        }
        .calendar-day::before {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(168, 85, 247, 0.2));
            opacity: 0; transition: opacity 0.3s ease;
        }
        .calendar-day:hover::before { opacity: 1; }
        
        .gradient-text {
            background: linear-gradient(135deg, #3b82f6, #a855f7, #ec4899);
            background-size: 200% 200%; -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            animation: gradientShift 3s ease infinite;
        }
        .gradient-text-gold {
            background: linear-gradient(135deg, #facc15, #fbbf24, #f59e0b);
            background-size: 200% 200%; -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
            animation: gradientShift 3s ease infinite;
        }
        
        @keyframes progressSlide { 0% { background-position: 0% 0%; } 100% { background-position: 100% 0%; } }
        .progress-animated {
            background: linear-gradient(90deg, #3b82f6, #a855f7, #ec4899, #3b82f6);
            background-size: 200% 100%; animation: progressSlide 2s linear infinite;
        }
        
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .float-animation { animation: float 3s ease-in-out infinite; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        
        .stagger-1 { animation-delay: 0.1s; } .stagger-2 { animation-delay: 0.2s; }
        .stagger-3 { animation-delay: 0.3s; } .stagger-4 { animation-delay: 0.4s; }
        
        input:focus, select:focus {
            outline: none; border-color: rgba(59, 130, 246, 0.5);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 0 20px rgba(59, 130, 246, 0.3);
        }
        select option { color: black; background: white; }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            position: relative; overflow: hidden;
        }
        .btn-primary::before {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }
        .btn-primary:hover::before { left: 100%; }
        
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.3); } 50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.6); } }
        .stat-glow { animation: pulse-glow 2s ease-in-out infinite; }
        
        .install-prompt {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%); z-index: 1000;
            animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes slideUp { from { transform: translateX(-50%) translateY(100px); opacity: 0; } to { transform: translateX(-50%) translateY(0); opacity: 1; } }
        
        .ripple { position: relative; overflow: hidden; }
        .ripple::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 0; height: 0; border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transform: translate(-50%, -50%); transition: width 0.6s, height 0.6s;
        }
        .ripple:active::after { width: 300px; height: 300px; }

        #confetti-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999; overflow: hidden;
        }
        .confetti {
            position: absolute; width: 10px; height: 20px; opacity: 0.7;
            animation: confetti-fall 3s ease-out forwards;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white; border-radius: 50%;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-animated text-white min-h-screen">
    <div class="fixed inset-0 bg-gradient-to-br from-blue-500/5 via-purple-500/5 to-pink-500/5 pointer-events-none"></div>
    <div id="confetti-container"></div>
    <div id="app" class="relative max-w-6xl mx-auto p-4 md:p-6 pb-24"></div>

    <script>
        // --- NEW: Badge Definitions ---
        const badgeData = {
            // Workout Count
            firstWorkout: { title: 'Getting Started', desc: 'Log your first workout', icon: 'ðŸŽ‰' },
            workout10: { title: 'Dedicated', desc: 'Log 10 workouts', icon: 'ðŸ’ª' },
            workout25: { title: 'Committed', desc: 'Log 25 workouts', icon: 'ðŸŽ¯' },
            workout50: { title: 'Veteran', desc: 'Log 50 workouts', icon: 'ðŸ‹ï¸' },
            workout100: { title: 'Centurion', desc: 'Log 100 workouts', icon: 'ðŸ’¯' },
            workout200: { title: 'Champion', desc: 'Log 200 workouts', icon: 'ðŸ†' },
            workout365: { title: 'Year Round', desc: 'Log 365 workouts', icon: 'ðŸ“…' },
            workout500: { title: 'Legend', desc: 'Log 500 workouts', icon: 'ðŸ‘‘' },
            workout1000: { title: 'Immortal', desc: 'Log 1000 workouts', icon: 'âš¡' },
            
            // Streak
            streak3: { title: 'Hot Start', desc: 'Hit a 3-day streak', icon: 'ðŸŒŸ' },
            streak7: { title: 'Week Warrior', desc: 'Hit a 7-day streak', icon: 'ðŸ“†' },
            streak10: { title: 'On Fire', desc: 'Hit a 10-day streak', icon: 'ðŸ”¥' },
            streak21: { title: 'Habit Former', desc: 'Hit a 21-day streak', icon: 'ðŸŒ±' },
            streak30: { title: 'Unstoppable', desc: 'Hit a 30-day streak', icon: 'â˜„ï¸' },
            streak65: { title: 'Relentless', desc: 'Hit a 65-day streak', icon: 'â›“ï¸' },
            streak100: { title: 'Century Streak', desc: 'Hit a 100-day streak', icon: 'ðŸ’¥' },
            streak180: { title: 'Half Year', desc: 'Hit a 180-day streak', icon: 'ðŸŽŠ' },
            streak365: { title: 'Full Year', desc: 'Hit a 365-day streak', icon: 'ðŸŽ†' },
            
            // Volume
            volume5k: { title: 'Getting Heavy', desc: 'Lift 5,000 total volume', icon: 'ðŸ“Š' },
            volume10k: { title: 'Moving Up', desc: 'Lift 10,000 total volume', icon: 'ðŸ“ˆ' },
            volume25k: { title: 'Quarter Century', desc: 'Lift 25,000 total volume', icon: 'ðŸ—ï¸' },
            volume50k: { title: 'Halfway There', desc: 'Lift 50,000 total volume', icon: 'âš™ï¸' },
            volume100k: { title: 'Heavy Hitter', desc: 'Lift 100,000 total volume', icon: 'ðŸ’¥' },
            volume250k: { title: 'Quarter Million', desc: 'Lift 250,000 total volume', icon: 'ðŸ­' },
            volume500k: { title: 'Half Million', desc: 'Lift 500,000 total volume', icon: 'ðŸš€' },
            volume1M: { title: 'Millionaire', desc: 'Lift 1,000,000 total volume', icon: 'ðŸ’°' },
            volume5M: { title: 'Multi-Millionaire', desc: 'Lift 5,000,000 total volume', icon: 'ðŸ’Ž' },
            
            // Bench Press (Lbs)
            bench95: { title: 'Bench Beginner', desc: 'Bench 95 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench135: { title: 'One-Plate Bench', desc: 'Bench 135 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench185: { title: 'Solid Bench', desc: 'Bench 185 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench225: { title: 'Two-Plate Bench', desc: 'Bench 225 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench275: { title: 'Strong Bench', desc: 'Bench 275 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench315: { title: 'Three-Plate Bench', desc: 'Bench 315 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench365: { title: 'Elite Bench', desc: 'Bench 365 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench405: { title: 'Four-Plate Bench', desc: 'Bench 405 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench500: { title: 'Legendary Bench', desc: 'Bench 500 lbs', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            
            // Squat (Lbs)
            squat135: { title: 'Squat Starter', desc: 'Squat 135 lbs', icon: 'ðŸ¦µ' },
            squat185: { title: 'Solid Squat', desc: 'Squat 185 lbs', icon: 'ðŸ¦µ' },
            squat225: { title: 'Two-Plate Squat', desc: 'Squat 225 lbs', icon: 'ðŸ¦µ' },
            squat275: { title: 'Strong Squat', desc: 'Squat 275 lbs', icon: 'ðŸ¦µ' },
            squat315: { title: 'Three-Plate Squat', desc: 'Squat 315 lbs', icon: 'ðŸ¦µ' },
            squat365: { title: 'Elite Squat', desc: 'Squat 365 lbs', icon: 'ðŸ¦µ' },
            squat405: { title: 'Four-Plate Squat', desc: 'Squat 405 lbs', icon: 'ðŸ¦µ' },
            squat495: { title: 'Five-Plate Squat', desc: 'Squat 495 lbs', icon: 'ðŸ¦µ' },
            squat585: { title: 'Six-Plate Squat', desc: 'Squat 585 lbs', icon: 'ðŸ¦µ' },
            
            // Deadlift (Lbs)
            deadlift135: { title: 'Deadlift Starter', desc: 'Deadlift 135 lbs', icon: 'ðŸš€' },
            deadlift225: { title: 'Two-Plate Deadlift', desc: 'Deadlift 225 lbs', icon: 'ðŸš€' },
            deadlift315: { title: 'Three-Plate Deadlift', desc: 'Deadlift 315 lbs', icon: 'ðŸš€' },
            deadlift405: { title: 'Four-Plate Deadlift', desc: 'Deadlift 405 lbs', icon: 'ðŸš€' },
            deadlift495: { title: 'Five-Plate Deadlift', desc: 'Deadlift 495 lbs', icon: 'ðŸš€' },
            deadlift585: { title: 'Six-Plate Deadlift', desc: 'Deadlift 585 lbs', icon: 'ðŸš€' },
            deadlift675: { title: 'Seven-Plate Deadlift', desc: 'Deadlift 675 lbs', icon: 'ðŸš€' },
            
            // Bench (Kg)
            bench60kg: { title: '60kg Bench', desc: 'Bench 60 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench80kg: { title: '80kg Bench', desc: 'Bench 80 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench100kg: { title: '100kg Bench', desc: 'Bench 100 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench120kg: { title: '120kg Bench', desc: 'Bench 120 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench140kg: { title: '140kg Bench', desc: 'Bench 140 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench160kg: { title: '160kg Bench', desc: 'Bench 160 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench180kg: { title: '180kg Bench', desc: 'Bench 180 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            bench200kg: { title: '200kg Bench', desc: 'Bench 200 kg', icon: 'ðŸ‹ï¸â€â™‚ï¸' },
            
            // Squat (Kg)
            squat100kg: { title: '100kg Squat', desc: 'Squat 100 kg', icon: 'ðŸ¦µ' },
            squat120kg: { title: '120kg Squat', desc: 'Squat 120 kg', icon: 'ðŸ¦µ' },
            squat140kg: { title: '140kg Squat', desc: 'Squat 140 kg', icon: 'ðŸ¦µ' },
            squat160kg: { title: '160kg Squat', desc: 'Squat 160 kg', icon: 'ðŸ¦µ' },
            squat180kg: { title: '180kg Squat', desc: 'Squat 180 kg', icon: 'ðŸ¦µ' },
            squat200kg: { title: '200kg Squat', desc: 'Squat 200 kg', icon: 'ðŸ¦µ' },
            squat220kg: { title: '220kg Squat', desc: 'Squat 220 kg', icon: 'ðŸ¦µ' },
            squat250kg: { title: '250kg Squat', desc: 'Squat 250 kg', icon: 'ðŸ¦µ' },
            
            // Deadlift (Kg)
            deadlift100kg: { title: '100kg Deadlift', desc: 'Deadlift 100 kg', icon: 'ðŸš€' },
            deadlift140kg: { title: '140kg Deadlift', desc: 'Deadlift 140 kg', icon: 'ðŸš€' },
            deadlift180kg: { title: '180kg Deadlift', desc: 'Deadlift 180 kg', icon: 'ðŸš€' },
            deadlift220kg: { title: '220kg Deadlift', desc: 'Deadlift 220 kg', icon: 'ðŸš€' },
            deadlift260kg: { title: '260kg Deadlift', desc: 'Deadlift 260 kg', icon: 'ðŸš€' },
            deadlift300kg: { title: '300kg Deadlift', desc: 'Deadlift 300 kg', icon: 'ðŸš€' },
            
            // Bodyweight Ratio Badges - Male
            benchBodyweightMale: { title: 'Bodyweight Bench (M)', desc: 'Bench 1x bodyweight (Male)', icon: 'ðŸ’ª', requirement: { gender: 'male', exercise: 'bench', ratio: 1.0 } },
            bench125BodyweightMale: { title: 'Bench 1.25x BW (M)', desc: 'Bench 1.25x bodyweight (Male)', icon: 'ðŸ’ª', requirement: { gender: 'male', exercise: 'bench', ratio: 1.25 } },
            bench15BodyweightMale: { title: 'Bench 1.5x BW (M)', desc: 'Bench 1.5x bodyweight (Male)', icon: 'ðŸ’ª', requirement: { gender: 'male', exercise: 'bench', ratio: 1.5 } },
            bench2BodyweightMale: { title: 'Bench 2x BW (M)', desc: 'Bench 2x bodyweight (Male)', icon: 'ðŸ’ª', requirement: { gender: 'male', exercise: 'bench', ratio: 2.0 } },
            
            squatBodyweightMale: { title: 'Bodyweight Squat (M)', desc: 'Squat 1x bodyweight (Male)', icon: 'ðŸ¦µ', requirement: { gender: 'male', exercise: 'squat', ratio: 1.0 } },
            squat15BodyweightMale: { title: 'Squat 1.5x BW (M)', desc: 'Squat 1.5x bodyweight (Male)', icon: 'ðŸ¦µ', requirement: { gender: 'male', exercise: 'squat', ratio: 1.5 } },
            squat2BodyweightMale: { title: 'Squat 2x BW (M)', desc: 'Squat 2x bodyweight (Male)', icon: 'ðŸ¦µ', requirement: { gender: 'male', exercise: 'squat', ratio: 2.0 } },
            squat25BodyweightMale: { title: 'Squat 2.5x BW (M)', desc: 'Squat 2.5x bodyweight (Male)', icon: 'ðŸ¦µ', requirement: { gender: 'male', exercise: 'squat', ratio: 2.5 } },
            squat3BodyweightMale: { title: 'Squat 3x BW (M)', desc: 'Squat 3x bodyweight (Male)', icon: 'ðŸ¦µ', requirement: { gender: 'male', exercise: 'squat', ratio: 3.0 } },
            
            deadlift15BodyweightMale: { title: 'Deadlift 1.5x BW (M)', desc: 'Deadlift 1.5x bodyweight (Male)', icon: 'ðŸš€', requirement: { gender: 'male', exercise: 'deadlift', ratio: 1.5 } },
            deadlift2BodyweightMale: { title: 'Deadlift 2x BW (M)', desc: 'Deadlift 2x bodyweight (Male)', icon: 'ðŸš€', requirement: { gender: 'male', exercise: 'deadlift', ratio: 2.0 } },
            deadlift25BodyweightMale: { title: 'Deadlift 2.5x BW (M)', desc: 'Deadlift 2.5x bodyweight (Male)', icon: 'ðŸš€', requirement: { gender: 'male', exercise: 'deadlift', ratio: 2.5 } },
            deadlift3BodyweightMale: { title: 'Deadlift 3x BW (M)', desc: 'Deadlift 3x bodyweight (Male)', icon: 'ðŸš€', requirement: { gender: 'male', exercise: 'deadlift', ratio: 3.0 } },
            
            // Bodyweight Ratio Badges - Female
            benchBodyweightFemale: { title: 'Bodyweight Bench (F)', desc: 'Bench 0.75x bodyweight (Female)', icon: 'ðŸ’ª', requirement: { gender: 'female', exercise: 'bench', ratio: 0.75 } },
            bench1BodyweightFemale: { title: 'Bench 1x BW (F)', desc: 'Bench 1x bodyweight (Female)', icon: 'ðŸ’ª', requirement: { gender: 'female', exercise: 'bench', ratio: 1.0 } },
            bench125BodyweightFemale: { title: 'Bench 1.25x BW (F)', desc: 'Bench 1.25x bodyweight (Female)', icon: 'ðŸ’ª', requirement: { gender: 'female', exercise: 'bench', ratio: 1.25 } },
            bench15BodyweightFemale: { title: 'Bench 1.5x BW (F)', desc: 'Bench 1.5x bodyweight (Female)', icon: 'ðŸ’ª', requirement: { gender: 'female', exercise: 'bench', ratio: 1.5 } },
            
            squatBodyweightFemale: { title: 'Bodyweight Squat (F)', desc: 'Squat 1x bodyweight (Female)', icon: 'ðŸ¦µ', requirement: { gender: 'female', exercise: 'squat', ratio: 1.0 } },
            squat125BodyweightFemale: { title: 'Squat 1.25x BW (F)', desc: 'Squat 1.25x bodyweight (Female)', icon: 'ðŸ¦µ', requirement: { gender: 'female', exercise: 'squat', ratio: 1.25 } },
            squat15BodyweightFemale: { title: 'Squat 1.5x BW (F)', desc: 'Squat 1.5x bodyweight (Female)', icon: 'ðŸ¦µ', requirement: { gender: 'female', exercise: 'squat', ratio: 1.5 } },
            squat2BodyweightFemale: { title: 'Squat 2x BW (F)', desc: 'Squat 2x bodyweight (Female)', icon: 'ðŸ¦µ', requirement: { gender: 'female', exercise: 'squat', ratio: 2.0 } },
            squat25BodyweightFemale: { title: 'Squat 2.5x BW (F)', desc: 'Squat 2.5x bodyweight (Female)', icon: 'ðŸ¦µ', requirement: { gender: 'female', exercise: 'squat', ratio: 2.5 } },
            
            deadlift125BodyweightFemale: { title: 'Deadlift 1.25x BW (F)', desc: 'Deadlift 1.25x bodyweight (Female)', icon: 'ðŸš€', requirement: { gender: 'female', exercise: 'deadlift', ratio: 1.25 } },
            deadlift15BodyweightFemale: { title: 'Deadlift 1.5x BW (F)', desc: 'Deadlift 1.5x bodyweight (Female)', icon: 'ðŸš€', requirement: { gender: 'female', exercise: 'deadlift', ratio: 1.5 } },
            deadlift2BodyweightFemale: { title: 'Deadlift 2x BW (F)', desc: 'Deadlift 2x bodyweight (Female)', icon: 'ðŸš€', requirement: { gender: 'female', exercise: 'deadlift', ratio: 2.0 } },
            deadlift25BodyweightFemale: { title: 'Deadlift 2.5x BW (F)', desc: 'Deadlift 2.5x bodyweight (Female)', icon: 'ðŸš€', requirement: { gender: 'female', exercise: 'deadlift', ratio: 2.5 } },
            
            // Age-based achievements
            lifter20s: { title: 'Young Gun', desc: 'Log 50 workouts in your 20s', icon: 'ðŸ”«', requirement: { ageRange: [20, 29], workouts: 50 } },
            lifter30s: { title: 'Prime Time', desc: 'Log 50 workouts in your 30s', icon: 'â­', requirement: { ageRange: [30, 39], workouts: 50 } },
            lifter40s: { title: 'Master', desc: 'Log 50 workouts in your 40s', icon: 'ðŸŽ–ï¸', requirement: { ageRange: [40, 49], workouts: 50 } },
            lifter50s: { title: 'Veteran', desc: 'Log 50 workouts in your 50s', icon: 'ðŸ…', requirement: { ageRange: [50, 59], workouts: 50 } },
            lifter60plus: { title: 'Legend', desc: 'Log 50 workouts at 60+', icon: 'ðŸ‘‘', requirement: { ageRange: [60, 120], workouts: 50 } },
            
            // Consistency
            earlyBird: { title: 'Early Bird', desc: 'Log 10 workouts before 7 AM', icon: 'ðŸ¦' },
            nightOwl: { title: 'Night Owl', desc: 'Log 10 workouts after 9 PM', icon: 'ðŸ¦‰' },
            weekendWarrior: { title: 'Weekend Warrior', desc: 'Log 20 weekend workouts', icon: 'ðŸ—“ï¸' },
            everydayAthlete: { title: 'Everyday Athlete', desc: 'Log 30 weekday workouts', icon: 'ðŸ“‹' },
            
            // Cardio
            cardioKing: { title: 'Cardio King', desc: 'Log 20 cardio sessions', icon: 'ðŸƒâ€â™‚ï¸' },
            cardio50: { title: 'Cardio Enthusiast', desc: 'Log 50 cardio sessions', icon: 'ðŸƒ' },
            cardio100: { title: 'Cardio Fanatic', desc: 'Log 100 cardio sessions', icon: 'ðŸƒâ€â™€ï¸' },
            marathon: { title: 'Marathon Runner', desc: 'Run for 240+ min cumulative', icon: 'ðŸŽ½' },
            
            // Misc
            allRounder: { title: 'All-Rounder', desc: 'Log 5+ different exercises in one workout', icon: 'ðŸŽ­' },
            diverseTrainer: { title: 'Diverse Trainer', desc: 'Log 20+ different exercises total', icon: 'ðŸŒˆ' },
            masterOfAll: { title: 'Master of All', desc: 'Log 50+ different exercises total', icon: 'ðŸŽ¨' },
        };

        // State Management
        let state = {
            view: 'home', 
            weight: '', unit: 'lbs', bar: 'standard', exercise: 'squat', bodyweight: localStorage.getItem('bodyweight') || '',
            gender: localStorage.getItem('gender') || 'male', 
            age: localStorage.getItem('age') || '',
            category: 'natural', strengthWeight: '', 
            userName: localStorage.getItem('userName') || '',
            workouts: JSON.parse(localStorage.getItem('workouts') || '[]'),
            plans: JSON.parse(localStorage.getItem('plans') || '{}'),
            routines: JSON.parse(localStorage.getItem('routines') || '[]'),
            currentSets: [], currentRoutineSets: [], currentRoutineName: '',
            prs: JSON.parse(localStorage.getItem('prs') || '[]'),
            workoutExercise: 'squat', workoutWeight: '', workoutReps: '', workoutSets: '1',
            logActivityType: 'strength', routineActivityType: 'strength',
            workoutCardioExercise: 'run', workoutCardioDuration: '',
            showNameDialog: false, showPRDialog: false, prData: null,
            repWeight: '', reps: '',
            selectedDate: new Date(), calendarMonth: new Date().getMonth(), calendarYear: new Date().getFullYear(),
            showCalendarModal: false, selectedCalendarDate: null,
            planType: 'activity', planActivityType: 'strength', planStrengthExercise: 'squat',
            planCardioExercise: 'run', planCardioDuration: '', planNotes: '', planRoutineId: '',
            pendingWorkout: null, pendingPRs: [],
            strengthResult: null, oneRMResult: null, plateResult: null,
            progressChartType: 'weight',
            
            // Gamification & Live Workout State
            xp: JSON.parse(localStorage.getItem('xp') || '0'),
            badges: JSON.parse(localStorage.getItem('badges') || '[]'),
            newlyAwardedBadges: [],
            showBadgeModal: false,
            
            liveSetIndex: 0, isResting: false, restTimerRemaining: 0,
            restTimerId: null, restDuration: 60, 
            
            isFinishing: false,
            showTimerModal: false, // NEW: For rest timer setting
            showRoutinePreview: false,
            previewRoutineId: null
        };

        // DATA MIGRATION
        (function migrateData() {
            let needsSave = false;
            state.workouts.forEach(w => {
                if (w.sets && !w.activities) {
                    w.activities = w.sets.map(s => ({...s, type: 'strength'}));
                    delete w.sets;
                    needsSave = true;
                }
            });
            if (needsSave) {
                console.log('Migrating old workout data...');
                localStorage.setItem('workouts', JSON.stringify(state.workouts));
            }
        })();

        // Exercise Data
        const exercises = {
            abWheel: 'Ab Wheel Rollout', arnoldPress: 'Arnold Press', stoneLoad: 'Atlas Stone Load', axlePress: 'Axle Press',
            backExtension: 'Back Extension', row: 'Barbell Row', bench: 'Bench Press', bicepcurl: 'Bicep Curl',
            boxSquat: 'Box Squat', bulgarianSplit: 'Bulgarian Split Squat', cableRow: 'Cable Row', cableWoodchop: 'Cable Woodchop',
            calfRaise: 'Calf Raise', chestRow: 'Chest Supported Row', chinups: 'Chin-ups', cleanJerk: 'Clean and Jerk',
            closeBench: 'Close Grip Bench', deadlift: 'Deadlift', declineBench: 'Decline Bench Press', deficitDL: 'Deficit Deadlift',
            dips: 'Dips', dbBench: 'Dumbbell Bench Press', dbOHP: 'Dumbbell Overhead Press', dbRow: 'Dumbbell Row',
            facePulls: 'Face Pulls', farmersWalk: "Farmer's Walk", floorPress: 'Floor Press', frontSquat: 'Front Squat',
            gluteBridge: 'Glute Bridge', gobletSquat: 'Goblet Squat', hackSquat: 'Hack Squat', hammerCurl: 'Hammer Curl',
            hangClean: 'Hang Clean', hangingLegRaise: 'Hanging Leg Raise', hipThrust: 'Hip Thrust', inclineBench: 'Incline Bench Press',
            latPulldown: 'Lat Pulldown', lateralRaise: 'Lateral Raise', legCurl: 'Leg Curl', legExtension: 'Leg Extension',
            legPress: 'Leg Press', logPress: 'Log Press', lunges: 'Lunges', ohp: 'Overhead Press',
            pauseBench: 'Pause Bench Press', pauseSquat: 'Pause Squat', pendlayRow: 'Pendlay Row', plank: 'Plank',
            plateHold: 'Plate Hold', powerClean: 'Power Clean', powerSnatch: 'Power Snatch', preacherCurl: 'Preacher Curl',
            pullups: 'Pull-ups', pushPress: 'Push Press', rackPull: 'Rack Pull', romanianDL: 'Romanian Deadlift',
            russianTwist: 'Russian Twist', seatedCalfRaise: 'Seated Calf Raise', seatedOHP: 'Seated Overhead Press',
            shrugs: 'Shrugs', skullcrushers: 'Skullcrushers', snatch: 'Snatch', squat: 'Squat',
            stiffLegDL: 'Stiff Leg Deadlift', sumoDeadlift: 'Sumo Deadlift', tbarRow: 'T-Bar Row', tireFlip: 'Tire Flip',
            trapBarDL: 'Trap Bar Deadlift', tricepExt: 'Tricep Extension', vikingPress: 'Viking Press', yokeWalk: 'Yoke Walk'
        };
        const cardioExercises = {
            run: 'Running', cycle: 'Cycling', rowing: 'Rowing Machine', elliptical: 'Elliptical',
            stairs: 'Stair Climber', jumpRope: 'Jump Rope', walk: 'Walking (Incline)', swim: 'Swimming',
            other: 'Other Cardio'
        };
        // Bar and Plate Data
        const bars = { 
            standard: { lbs: 45, kg: 20 }, womens: { lbs: 35, kg: 15 }, 
            ezBar: { lbs: 25, kg: 11 }, trap: { lbs: 60, kg: 27 } 
        };
        const barNames = { 
            standard: 'Standard Bar (45/20)', womens: "Women's Bar (35/15)", 
            ezBar: 'EZ Curl Bar (25/11)', trap: 'Trap Bar (60/27)' 
        };
        const plates = { 
            lbs: [45, 35, 25, 10, 5, 2.5], kg: [25, 20, 15, 10, 5, 2.5, 1.25] 
        };
        
        // Default Routines (abbreviated)
        const defaultRoutines = [
            { id: 1001, name: 'Default: Full Body', activities: [/* ... */] },
            { id: 1002, name: 'Default: Push Day', activities: [/* ... */] },
            { id: 1003, name: 'Default: Pull Day', activities: [/* ... */] },
            { id: 1004, name: 'Default: Leg Day', activities: [/* ... */] },
            { id: 1005, name: 'Default: Cardio Blast', activities: [/* ... */] }
        ];
        (function loadDefaultRoutines() {
            // (Full defaultRoutines array omitted for brevity, it's unchanged)
            const fullDefaultRoutines = [
                { id: 1001, name: 'Default: Full Body', activities: [ { id: 1, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 2, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 3, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 4, type: 'strength', exercise: 'Bench Press', weight: '', reps: '5', unit: 'lbs' }, { id: 5, type: 'strength', exercise: 'Bench Press', weight: '', reps: '5', unit: 'lbs' }, { id: 6, type: 'strength', exercise: 'Bench Press', weight: '', reps: '5', unit: 'lbs' }, { id: 7, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '5', unit: 'lbs' }, { id: 8, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '5', unit: 'lbs' }, { id: 9, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '5', unit: 'lbs' }, { id: 10, type: 'cardio', exercise: 'Running', duration: 10 } ] },
                { id: 1002, name: 'Default: Push Day', activities: [ { id: 11, type: 'strength', exercise: 'Bench Press', weight: '', reps: '8', unit: 'lbs' }, { id: 12, type: 'strength', exercise: 'Bench Press', weight: '', reps: '8', unit: 'lbs' }, { id: 13, type: 'strength', exercise: 'Bench Press', weight: '', reps: '8', unit: 'lbs' }, { id: 14, type: 'strength', exercise: 'Overhead Press', weight: '', reps: '10', unit: 'lbs' }, { id: 15, type: 'strength', exercise: 'Overhead Press', weight: '', reps: '10', unit: 'lbs' }, { id: 16, type: 'strength', exercise: 'Dips', weight: '', reps: '12', unit: 'lbs' }, { id: 17, type: 'strength', exercise: 'Dips', weight: '', reps: '12', unit: 'lbs' } ] },
                { id: 1003, name: 'Default: Pull Day', activities: [ { id: 18, type: 'strength', exercise: 'Deadlift', weight: '', reps: '5', unit: 'lbs' }, { id: 19, type: 'strength', exercise: 'Pull-ups', weight: '', reps: '8', unit: 'lbs' }, { id: 20, type: 'strength', exercise: 'Pull-ups', weight: '', reps: '8', unit: 'lbs' }, { id: 21, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '10', unit: 'lbs' }, { id: 22, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '10', unit: 'lbs' }, { id: 23, type: 'strength', exercise: 'Bicep Curl', weight: '', reps: '12', unit: 'lbs' } ] },
                { id: 1004, name: 'Default: Leg Day', activities: [ { id: 24, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 25, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 26, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 27, type: 'strength', exercise: 'Romanian Deadlift', weight: '', reps: '10', unit: 'lbs' }, { id: 28, type: 'strength', exercise: 'Romanian Deadlift', weight: '', reps: '10', unit: 'lbs' }, { id: 29, type: 'strength', exercise: 'Leg Press', weight: '', reps: '12', unit: 'lbs' }, { id: 30, type: 'strength', exercise: 'Calf Raise', weight: '', reps: '15', unit: 'lbs' } ] },
                { id: 1005, name: 'Default: Cardio Blast', activities: [ { id: 31, type: 'cardio', exercise: 'Running', duration: 15 }, { id: 32, type: 'cardio', exercise: 'Cycling', duration: 15 }, { id: 33, type: 'cardio', exercise: 'Rowing Machine', duration: 10 } ] },
                { id: 1006, name: 'Default: Upper Body A', activities: [ { id: 34, type: 'strength', exercise: 'Bench Press', weight: '', reps: '6', unit: 'lbs' }, { id: 35, type: 'strength', exercise: 'Bench Press', weight: '', reps: '6', unit: 'lbs' }, { id: 36, type: 'strength', exercise: 'Bench Press', weight: '', reps: '6', unit: 'lbs' }, { id: 37, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '8', unit: 'lbs' }, { id: 38, type: 'strength', exercise: 'Barbell Row', weight: '', reps: '8', unit: 'lbs' }, { id: 39, type: 'strength', exercise: 'Overhead Press', weight: '', reps: '10', unit: 'lbs' }, { id: 40, type: 'strength', exercise: 'Pull-ups', weight: '', reps: '8', unit: 'lbs' }, { id: 41, type: 'strength', exercise: 'Dips', weight: '', reps: '10', unit: 'lbs' } ] },
                { id: 1007, name: 'Default: Lower Body A', activities: [ { id: 42, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 43, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 44, type: 'strength', exercise: 'Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 45, type: 'strength', exercise: 'Romanian Deadlift', weight: '', reps: '8', unit: 'lbs' }, { id: 46, type: 'strength', exercise: 'Romanian Deadlift', weight: '', reps: '8', unit: 'lbs' }, { id: 47, type: 'strength', exercise: 'Leg Press', weight: '', reps: '12', unit: 'lbs' }, { id: 48, type: 'strength', exercise: 'Leg Curl', weight: '', reps: '12', unit: 'lbs' }, { id: 49, type: 'strength', exercise: 'Calf Raise', weight: '', reps: '15', unit: 'lbs' } ] },
                { id: 1008, name: 'Default: Power Building', activities: [ { id: 50, type: 'strength', exercise: 'Deadlift', weight: '', reps: '3', unit: 'lbs' }, { id: 51, type: 'strength', exercise: 'Deadlift', weight: '', reps: '3', unit: 'lbs' }, { id: 52, type: 'strength', exercise: 'Deadlift', weight: '', reps: '3', unit: 'lbs' }, { id: 53, type: 'strength', exercise: 'Bench Press', weight: '', reps: '3', unit: 'lbs' }, { id: 54, type: 'strength', exercise: 'Bench Press', weight: '', reps: '3', unit: 'lbs' }, { id: 55, type: 'strength', exercise: 'Squat', weight: '', reps: '3', unit: 'lbs' }, { id: 56, type: 'strength', exercise: 'Squat', weight: '', reps: '3', unit: 'lbs' }, { id: 57, type: 'strength', exercise: 'Overhead Press', weight: '', reps: '5', unit: 'lbs' } ] },
                { id: 1009, name: 'Default: Olympic Lifting', activities: [ { id: 58, type: 'strength', exercise: 'Power Clean', weight: '', reps: '3', unit: 'lbs' }, { id: 59, type: 'strength', exercise: 'Power Clean', weight: '', reps: '3', unit: 'lbs' }, { id: 60, type: 'strength', exercise: 'Power Clean', weight: '', reps: '3', unit: 'lbs' }, { id: 61, type: 'strength', exercise: 'Power Snatch', weight: '', reps: '2', unit: 'lbs' }, { id: 62, type: 'strength', exercise: 'Power Snatch', weight: '', reps: '2', unit: 'lbs' }, { id: 63, type: 'strength', exercise: 'Front Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 64, type: 'strength', exercise: 'Front Squat', weight: '', reps: '5', unit: 'lbs' }, { id: 65, type: 'strength', exercise: 'Push Press', weight: '', reps: '5', unit: 'lbs' } ] },
                { id: 1010, name: 'Default: Bodybuilding Volume', activities: [ { id: 66, type: 'strength', exercise: 'Incline Bench Press', weight: '', reps: '12', unit: 'lbs' }, { id: 67, type: 'strength', exercise: 'Incline Bench Press', weight: '', reps: '12', unit: 'lbs' }, { id: 68, type: 'strength', exercise: 'Dumbbell Bench Press', weight: '', reps: '15', unit: 'lbs' }, { id: 69, type: 'strength', exercise: 'Dumbbell Bench Press', weight: '', reps: '15', unit: 'lbs' }, { id: 70, type: 'strength', exercise: 'Lateral Raise', weight: '', reps: '15', unit: 'lbs' }, { id: 71, type: 'strength', exercise: 'Lateral Raise', weight: '', reps: '15', unit: 'lbs' }, { id: 72, type: 'strength', exercise: 'Tricep Extension', weight: '', reps: '15', unit: 'lbs' }, { id: 73, type: 'strength', exercise: 'Bicep Curl', weight: '', reps: '15', unit: 'lbs' } ] }
            ];
            if (!state.routines.some(r => r.id === 1001)) {
                console.log('Loading default routines...');
                state.routines = [...fullDefaultRoutines, ...state.routines];
                localStorage.setItem('routines', JSON.stringify(state.routines));
            }
        })();

        // Strength Standards
        const strengthStandards = { /* ... unchanged ... */ };
        // Level Colors
        const levelColors = { /* ... unchanged ... */ };
        const levelBgColors = { /* ... unchanged ... */ };
        
        // --- Gamification Functions ---
        function addXp(amount) {
            state.xp = Number(state.xp) + amount;
            localStorage.setItem('xp', JSON.stringify(state.xp));
        }
        function calculateLevel() {
            const level = Math.floor(Math.pow(state.xp / 100, 0.5)) + 1;
            const xpForNextLevel = Math.pow((level), 2) * 100;
            const xpForThisLevel = Math.pow((level - 1), 2) * 100;
            const levelProgress = state.xp - xpForThisLevel;
            const levelTotalXp = xpForNextLevel - xpForThisLevel;
            const progressPercent = Math.max(0, Math.min(100, (levelProgress / levelTotalXp) * 100));
            return { level, progressPercent, nextLevelXp: xpForNextLevel };
        }

        // UPDATED: Badge Checking
        function checkAndAwardBadges(workout) {
            let newBadges = [];
            const currentBadgeSet = new Set(state.badges);
            
            // Helper function to check & add badge
            function checkBadge(badgeId, condition) {
                if (condition && !currentBadgeSet.has(badgeId)) {
                    newBadges.push(badgeId);
                    currentBadgeSet.add(badgeId);
                }
            }

            // 1. Workout Count
            const totalWorkouts = state.workouts.length;
            checkBadge('firstWorkout', totalWorkouts === 1);
            checkBadge('workout10', totalWorkouts >= 10);
            checkBadge('workout25', totalWorkouts >= 25);
            checkBadge('workout50', totalWorkouts >= 50);
            checkBadge('workout100', totalWorkouts >= 100);
            checkBadge('workout200', totalWorkouts >= 200);
            checkBadge('workout365', totalWorkouts >= 365);
            checkBadge('workout500', totalWorkouts >= 500);
            checkBadge('workout1000', totalWorkouts >= 1000);

            // 2. Streak
            const currentStreak = getStreak();
            checkBadge('streak3', currentStreak >= 3);
            checkBadge('streak7', currentStreak >= 7);
            checkBadge('streak10', currentStreak >= 10);
            checkBadge('streak21', currentStreak >= 21);
            checkBadge('streak30', currentStreak >= 30);
            checkBadge('streak65', currentStreak >= 65);
            checkBadge('streak100', currentStreak >= 100);
            checkBadge('streak180', currentStreak >= 180);
            checkBadge('streak365', currentStreak >= 365);

            // 3. Volume, Cardio, Time-based
            let totalVolume = 0;
            let cardioSessions = 0;
            let totalCardioTime = 0;
            let earlyBirds = 0;
            let nightOwls = 0;
            let weekendWorkouts = 0;
            let weekdayWorkouts = 0;
            let uniqueExercises = new Set();
            
            state.workouts.forEach(w => {
                totalVolume += (w.volume || 0);
                if (w.activities.some(a => a.type === 'cardio')) {
                    cardioSessions++;
                    w.activities.forEach(a => {
                        if (a.type === 'cardio' && a.duration) {
                            totalCardioTime += parseFloat(a.duration);
                        }
                    });
                }
                w.activities.forEach(a => {
                    if (a.exercise) uniqueExercises.add(a.exercise);
                });
                const hour = new Date(w.date).getHours();
                const day = new Date(w.date).getDay();
                if (hour < 7) earlyBirds++;
                if (hour >= 21) nightOwls++;
                if (day === 0 || day === 6) weekendWorkouts++;
                else weekdayWorkouts++;
            });
            
            checkBadge('volume5k', totalVolume >= 5000);
            checkBadge('volume10k', totalVolume >= 10000);
            checkBadge('volume25k', totalVolume >= 25000);
            checkBadge('volume50k', totalVolume >= 50000);
            checkBadge('volume100k', totalVolume >= 100000);
            checkBadge('volume250k', totalVolume >= 250000);
            checkBadge('volume500k', totalVolume >= 500000);
            checkBadge('volume1M', totalVolume >= 1000000);
            checkBadge('volume5M', totalVolume >= 5000000);
            
            checkBadge('cardioKing', cardioSessions >= 20);
            checkBadge('cardio50', cardioSessions >= 50);
            checkBadge('cardio100', cardioSessions >= 100);
            checkBadge('marathon', totalCardioTime >= 240);
            
            checkBadge('earlyBird', earlyBirds >= 10);
            checkBadge('nightOwl', nightOwls >= 10);
            checkBadge('weekendWarrior', weekendWorkouts >= 20);
            checkBadge('everydayAthlete', weekdayWorkouts >= 30);
            
            checkBadge('diverseTrainer', uniqueExercises.size >= 20);
            checkBadge('masterOfAll', uniqueExercises.size >= 50);

            // 4. Lifts from this workout - Absolute weights
            const activities = workout.activities || [];
            let exercisesInWorkout = new Set();
            activities.forEach(a => {
                if (a.type === 'strength' && a.exercise) {
                    exercisesInWorkout.add(a.exercise);
                    const weight = parseFloat(a.weight);
                    const weightLbs = a.unit === 'kg' ? weight * 2.20462 : weight;
                    const weightKg = a.unit === 'lbs' ? weight / 2.20462 : weight;

                    if (a.exercise === 'Bench Press') {
                        checkBadge('bench95', weightLbs >= 95);
                        checkBadge('bench135', weightLbs >= 135);
                        checkBadge('bench185', weightLbs >= 185);
                        checkBadge('bench225', weightLbs >= 225);
                        checkBadge('bench275', weightLbs >= 275);
                        checkBadge('bench315', weightLbs >= 315);
                        checkBadge('bench365', weightLbs >= 365);
                        checkBadge('bench405', weightLbs >= 405);
                        checkBadge('bench500', weightLbs >= 500);
                        checkBadge('bench60kg', weightKg >= 60);
                        checkBadge('bench80kg', weightKg >= 80);
                        checkBadge('bench100kg', weightKg >= 100);
                        checkBadge('bench120kg', weightKg >= 120);
                        checkBadge('bench140kg', weightKg >= 140);
                        checkBadge('bench160kg', weightKg >= 160);
                        checkBadge('bench180kg', weightKg >= 180);
                        checkBadge('bench200kg', weightKg >= 200);
                    }
                    if (a.exercise === 'Squat') {
                        checkBadge('squat135', weightLbs >= 135);
                        checkBadge('squat185', weightLbs >= 185);
                        checkBadge('squat225', weightLbs >= 225);
                        checkBadge('squat275', weightLbs >= 275);
                        checkBadge('squat315', weightLbs >= 315);
                        checkBadge('squat365', weightLbs >= 365);
                        checkBadge('squat405', weightLbs >= 405);
                        checkBadge('squat495', weightLbs >= 495);
                        checkBadge('squat585', weightLbs >= 585);
                        checkBadge('squat100kg', weightKg >= 100);
                        checkBadge('squat120kg', weightKg >= 120);
                        checkBadge('squat140kg', weightKg >= 140);
                        checkBadge('squat160kg', weightKg >= 160);
                        checkBadge('squat180kg', weightKg >= 180);
                        checkBadge('squat200kg', weightKg >= 200);
                        checkBadge('squat220kg', weightKg >= 220);
                        checkBadge('squat250kg', weightKg >= 250);
                    }
                    if (a.exercise === 'Deadlift') {
                        checkBadge('deadlift135', weightLbs >= 135);
                        checkBadge('deadlift225', weightLbs >= 225);
                        checkBadge('deadlift315', weightLbs >= 315);
                        checkBadge('deadlift405', weightLbs >= 405);
                        checkBadge('deadlift495', weightLbs >= 495);
                        checkBadge('deadlift585', weightLbs >= 585);
                        checkBadge('deadlift675', weightLbs >= 675);
                        checkBadge('deadlift100kg', weightKg >= 100);
                        checkBadge('deadlift140kg', weightKg >= 140);
                        checkBadge('deadlift180kg', weightKg >= 180);
                        checkBadge('deadlift220kg', weightKg >= 220);
                        checkBadge('deadlift260kg', weightKg >= 260);
                        checkBadge('deadlift300kg', weightKg >= 300);
                    }
                    
                    // Bodyweight ratio badges
                    const userBodyweight = parseFloat(state.bodyweight);
                    const userGender = state.gender;
                    if (userBodyweight > 0) {
                        const bodyweightLbs = state.unit === 'kg' ? userBodyweight * 2.20462 : userBodyweight;
                        const ratio = weightLbs / bodyweightLbs;
                        
                        // Male bodyweight ratio badges
                        if (userGender === 'male') {
                            if (a.exercise === 'Bench Press') {
                                checkBadge('benchBodyweightMale', ratio >= 1.0);
                                checkBadge('bench125BodyweightMale', ratio >= 1.25);
                                checkBadge('bench15BodyweightMale', ratio >= 1.5);
                                checkBadge('bench2BodyweightMale', ratio >= 2.0);
                            }
                            if (a.exercise === 'Squat') {
                                checkBadge('squatBodyweightMale', ratio >= 1.0);
                                checkBadge('squat15BodyweightMale', ratio >= 1.5);
                                checkBadge('squat2BodyweightMale', ratio >= 2.0);
                                checkBadge('squat25BodyweightMale', ratio >= 2.5);
                                checkBadge('squat3BodyweightMale', ratio >= 3.0);
                            }
                            if (a.exercise === 'Deadlift') {
                                checkBadge('deadlift15BodyweightMale', ratio >= 1.5);
                                checkBadge('deadlift2BodyweightMale', ratio >= 2.0);
                                checkBadge('deadlift25BodyweightMale', ratio >= 2.5);
                                checkBadge('deadlift3BodyweightMale', ratio >= 3.0);
                            }
                        }
                        
                        // Female bodyweight ratio badges
                        if (userGender === 'female') {
                            if (a.exercise === 'Bench Press') {
                                checkBadge('benchBodyweightFemale', ratio >= 0.75);
                                checkBadge('bench1BodyweightFemale', ratio >= 1.0);
                                checkBadge('bench125BodyweightFemale', ratio >= 1.25);
                                checkBadge('bench15BodyweightFemale', ratio >= 1.5);
                            }
                            if (a.exercise === 'Squat') {
                                checkBadge('squatBodyweightFemale', ratio >= 1.0);
                                checkBadge('squat125BodyweightFemale', ratio >= 1.25);
                                checkBadge('squat15BodyweightFemale', ratio >= 1.5);
                                checkBadge('squat2BodyweightFemale', ratio >= 2.0);
                                checkBadge('squat25BodyweightFemale', ratio >= 2.5);
                            }
                            if (a.exercise === 'Deadlift') {
                                checkBadge('deadlift125BodyweightFemale', ratio >= 1.25);
                                checkBadge('deadlift15BodyweightFemale', ratio >= 1.5);
                                checkBadge('deadlift2BodyweightFemale', ratio >= 2.0);
                                checkBadge('deadlift25BodyweightFemale', ratio >= 2.5);
                            }
                        }
                    }
                }
            });
            
            // 5. All-rounder badge (5+ exercises in one workout)
            checkBadge('allRounder', exercisesInWorkout.size >= 5);
            
            // 6. Age-based badges
            const userAge = parseInt(state.age);
            if (userAge > 0) {
                if (userAge >= 20 && userAge <= 29) checkBadge('lifter20s', totalWorkouts >= 50);
                if (userAge >= 30 && userAge <= 39) checkBadge('lifter30s', totalWorkouts >= 50);
                if (userAge >= 40 && userAge <= 49) checkBadge('lifter40s', totalWorkouts >= 50);
                if (userAge >= 50 && userAge <= 59) checkBadge('lifter50s', totalWorkouts >= 50);
                if (userAge >= 60) checkBadge('lifter60plus', totalWorkouts >= 50);
            }

            if (newBadges.length > 0) {
                state.badges = Array.from(currentBadgeSet);
                localStorage.setItem('badges', JSON.stringify(state.badges));
                state.newlyAwardedBadges = newBadges;
                state.showBadgeModal = true;
            }
        }

        // Calculator Handlers
        function handleCalculateStrength() { state.strengthResult = calculateStrength(); render(); }
        function handleCalculate1RM() { state.oneRMResult = calculate1RM(); render(); }
        function handleCalculatePlates() { state.plateResult = calculatePlates(); render(); }
        
        // Calculator Functions (calculatePlates, calculate1RM, calculateStrength)
        function calculatePlates() {
            const target = parseFloat(state.weight);
            
            // Validate input
            if (!target || isNaN(target) || target <= 0) return null;
            
            const barWeight = bars[state.bar][state.unit];
            
            // Check if weight is less than or equal to bar weight
            if (target <= barWeight) {
                return { error: 'Weight must be greater than bar weight' };
            }
            
            const weightToLoad = target - barWeight;
            const perSide = weightToLoad / 2;
            const result = [];
            let remaining = perSide;
            
            // Calculate plates needed
            for (const plate of plates[state.unit]) {
                const count = Math.floor(remaining / plate);
                if (count > 0) {
                    result.push({ weight: plate, count });
                    remaining -= plate * count;
                }
            }
            
            // Check if there's remaining weight that can't be loaded
            const tolerance = state.unit === 'kg' ? 0.1 : 0.5;
            if (remaining > tolerance) {
                const actualWeight = target - (remaining * 2);
                return { 
                    error: `Closest possible: ${actualWeight.toFixed(1)} ${state.unit} (${(remaining * 2).toFixed(1)} ${state.unit} short)`, 
                    plates: result 
                };
            }
            
            return { plates: result };
        }

        function calculate1RM() {
            const weight = parseFloat(state.repWeight);
            const reps = parseInt(state.reps);
            
            // Validate inputs
            if (!weight || isNaN(weight) || weight <= 0) return null;
            if (!reps || isNaN(reps) || reps <= 0 || reps > 12) return null;
            
            // If 1 rep, that's the 1RM
            if (reps === 1) {
                const percentages = {};
                [95, 90, 85, 80, 75, 70, 65, 60].forEach(pct => {
                    percentages[pct] = (weight * pct / 100).toFixed(1);
                });
                return { avg: weight.toFixed(1), percentages };
            }
            
            // Epley formula: 1RM = weight Ã— (1 + reps/30)
            const epley = weight * (1 + reps / 30);
            // Brzycki formula: 1RM = weight Ã— (36/(37-reps))
            const brzycki = weight * (36 / (37 - reps));
            // Average of both formulas
            const avg = (epley + brzycki) / 2;
            
            const percentages = {};
            [95, 90, 85, 80, 75, 70, 65, 60].forEach(pct => {
                percentages[pct] = (avg * pct / 100).toFixed(1);
            });
            
            return { avg: avg.toFixed(1), percentages };
        }

        function calculateStrength() {
            const bodyweight = parseFloat(state.bodyweight);
            const weight = parseFloat(state.strengthWeight || state.weight);
            
            // Validate inputs
            if (!bodyweight || isNaN(bodyweight) || bodyweight <= 0) return null;
            if (!weight || isNaN(weight) || weight <= 0) return null;
            
            // Check if exercise has strength standards
            const standardData = {
                natural: {
                    male: {
                        squat: {untrained: 0.65, novice: 1.15, intermediate: 1.70, advanced: 2.20, elite: 2.75},
                        bench: {untrained: 0.50, novice: 0.75, intermediate: 1.25, advanced: 1.75, elite: 2.25},
                        deadlift: {untrained: 0.80, novice: 1.40, intermediate: 2.00, advanced: 2.60, elite: 3.25},
                        ohp: {untrained: 0.35, novice: 0.55, intermediate: 0.85, advanced: 1.15, elite: 1.50},
                        row: {untrained: 0.40, novice: 0.70, intermediate: 1.10, advanced: 1.50, elite: 1.90}
                    },
                    female: {
                        squat: {untrained: 0.45, novice: 0.75, intermediate: 1.20, advanced: 1.60, elite: 2.05},
                        bench: {untrained: 0.30, novice: 0.50, intermediate: 0.80, advanced: 1.10, elite: 1.45},
                        deadlift: {untrained: 0.55, novice: 0.95, intermediate: 1.45, advanced: 1.90, elite: 2.45},
                        ohp: {untrained: 0.20, novice: 0.35, intermediate: 0.55, advanced: 0.75, elite: 1.00},
                        row: {untrained: 0.25, novice: 0.45, intermediate: 0.75, advanced: 1.00, elite: 1.30}
                    }
                },
                enhanced: {
                    male: {
                        squat: {untrained: 0.65, novice: 1.15, intermediate: 1.90, advanced: 2.60, elite: 3.50},
                        bench: {untrained: 0.50, novice: 0.75, intermediate: 1.40, advanced: 2.10, elite: 2.90},
                        deadlift: {untrained: 0.80, novice: 1.40, intermediate: 2.20, advanced: 3.00, elite: 4.20},
                        ohp: {untrained: 0.35, novice: 0.55, intermediate: 0.95, advanced: 1.40, elite: 1.95},
                        row: {untrained: 0.40, novice: 0.70, intermediate: 1.25, advanced: 1.80, elite: 2.45}
                    },
                    female: {
                        squat: {untrained: 0.45, novice: 0.75, intermediate: 1.35, advanced: 1.95, elite: 2.70},
                        bench: {untrained: 0.30, novice: 0.50, intermediate: 0.95, advanced: 1.40, elite: 1.95},
                        deadlift: {untrained: 0.55, novice: 0.95, intermediate: 1.65, advanced: 2.35, elite: 3.25},
                        ohp: {untrained: 0.20, novice: 0.35, intermediate: 0.65, advanced: 0.95, elite: 1.35},
                        row: {untrained: 0.25, novice: 0.45, intermediate: 0.90, advanced: 1.30, elite: 1.75}
                    }
                }
            };
            
            if (!standardData[state.category]?.[state.gender]?.[state.exercise]) {
                return null;
            }
            
            // Convert to lbs for calculation
            const weightLbs = state.unit === 'kg' ? weight * 2.20462 : weight;
            const bodyweightLbs = state.unit === 'kg' ? bodyweight * 2.20462 : bodyweight;
            const ratio = weightLbs / bodyweightLbs;
            
            const standards = standardData[state.category][state.gender][state.exercise];
            
            let level = 'beginner';
            let progress = 0;
            let nextLevel = 'untrained';
            
            if (ratio >= standards.elite) {
                level = 'elite';
                progress = 100;
                nextLevel = 'elite';
            } else if (ratio >= standards.advanced) {
                level = 'advanced';
                nextLevel = 'elite';
                progress = ((ratio - standards.advanced) / (standards.elite - standards.advanced)) * 100;
            } else if (ratio >= standards.intermediate) {
                level = 'intermediate';
                nextLevel = 'advanced';
                progress = ((ratio - standards.intermediate) / (standards.advanced - standards.intermediate)) * 100;
            } else if (ratio >= standards.novice) {
                level = 'novice';
                nextLevel = 'intermediate';
                progress = ((ratio - standards.novice) / (standards.intermediate - standards.novice)) * 100;
            } else if (ratio >= standards.untrained) {
                level = 'untrained';
                nextLevel = 'novice';
                progress = ((ratio - standards.untrained) / (standards.novice - standards.untrained)) * 100;
            } else {
                level = 'beginner';
                nextLevel = 'untrained';
                progress = (ratio / standards.untrained) * 100;
            }
            
            const nextWeight = standards[nextLevel] ? (standards[nextLevel] * bodyweightLbs) : null;
            const nextWeightConverted = nextWeight ? 
                (state.unit === 'kg' ? (nextWeight / 2.20462).toFixed(1) : nextWeight.toFixed(0)) : null;
            
            return {
                level,
                ratio: ratio.toFixed(2),
                progress: Math.min(progress, 100).toFixed(0),
                nextLevel,
                nextWeight: nextWeightConverted
            };
        }


        // Add Activity
        function addActivity() {
            if (state.logActivityType === 'strength') {
                if (!state.workoutReps) {
                    alert('Please enter reps to add a strength activity.');
                    return;
                }
                const numSets = parseInt(state.workoutSets) || 1;
                const sets = [];
                for (let i = 0; i < numSets; i++) {
                    sets.push({
                        id: Date.now() + i, type: 'strength', exercise: exercises[state.workoutExercise],
                        weight: parseFloat(state.workoutWeight) || 0, 
                        reps: parseInt(state.workoutReps), unit: state.unit
                    });
                }
                state.currentSets = [...state.currentSets, ...sets];
                addXp(10 * numSets);
                state.workoutWeight = ''; state.workoutReps = ''; state.workoutSets = '1';
            } else {
                if (!state.workoutCardioDuration) {
                    alert('Please enter a duration to add a cardio activity.');
                    return;
                }
                state.currentSets.push({
                    id: Date.now(), type: 'cardio', exercise: cardioExercises[state.workoutCardioExercise],
                    duration: parseFloat(state.workoutCardioDuration)
                });
                addXp(10);
                state.workoutCardioDuration = '';
            }
            render();
        }

        // Confetti
        function triggerConfetti() { /* ... unchanged ... */ }

        // PR Helper
        function isNewPR(exerciseName, weight, reps) {
            const w = parseFloat(weight); const r = parseInt(reps);
            if (isNaN(w) || isNaN(r) || w < 0 || r <= 0) return false; // Allow 0 weight
            const existingPRs = state.prs.filter(pr => pr.exercise === exerciseName && pr.unit === state.unit);
            if (existingPRs.length === 0) return true;
            const maxWeightPR = Math.max(0, ...existingPRs.map(pr => pr.weight));
            if (w > maxWeightPR) return true;
            if (w === maxWeightPR) {
                const repsAtMaxWeight = Math.max(0, ...existingPRs.filter(pr => pr.weight === maxWeightPR).map(pr => pr.reps));
                if (r > repsAtMaxWeight) return true;
            }
            return false;
        }
        
        // PR Modal Flow
        function showNextPR() {
            if (!state.pendingPRs || state.pendingPRs.length === 0) {
                savePendingWorkout();
                return;
            }
            const nextPR = state.pendingPRs.shift();
            state.prData = { exercise: nextPR.exercise, weight: nextPR.weight, reps: nextPR.reps };
            state.showPRDialog = true;
            render();
            triggerConfetti();
        }
        
        // Workout Save Flow
        function savePendingWorkout() {
            if (!state.pendingWorkout) return;
            state.workouts = [...state.workouts, state.pendingWorkout];
            localStorage.setItem('workouts', JSON.stringify(state.workouts));
            checkAndAwardBadges(state.pendingWorkout);
            
            state.currentSets = []; state.selectedCalendarDate = null;
            state.pendingWorkout = null; state.pendingPRs = [];
            state.liveSetIndex = 0; // Reset live index
            
            alert('ðŸŽ‰ Workout saved!');
            state.isFinishing = false;
            state.view = 'home';
            
            // --- BUG FIX ---
            // ALWAYS call render. The badge modal will show up if it needs to.
            render();
        }

        // Finish Workout
        function finishWorkout() {
            if (state.currentSets.length === 0) return;
            state.isFinishing = true;
            render();

            const now = new Date();
            const workoutDate = state.selectedCalendarDate ? 
                new Date(state.selectedCalendarDate + 'T' + now.toTimeString().split(' ')[0]) : // Combines selected date with current time
                now; // Uses current date and time

            const workout = {
                id: Date.now(), date: workoutDate.toISOString(), activities: state.currentSets,
                volume: state.currentSets.filter(a => a.type === 'strength')
                    .reduce((sum, set) => (sum + (parseFloat(set.weight) || 0) * (parseInt(set.reps) || 0)), 0)
            };
            addXp(50);
            
            const potentialPRs = state.currentSets.filter(a => a.type === 'strength' && isNewPR(a.exercise, a.weight, a.reps));
            const bestPRsMap = new Map();
            for (const pr of potentialPRs) {
                const key = pr.exercise; const existing = bestPRsMap.get(key);
                const prWeight = parseFloat(pr.weight); const prReps = parseInt(pr.reps);
                if (!existing) {
                    bestPRsMap.set(key, pr);
                } else {
                    const existingWeight = parseFloat(existing.weight); const existingReps = parseInt(existing.reps);
                    if (prWeight > existingWeight) { bestPRsMap.set(key, pr); }
                    else if (prWeight === existingWeight && prReps > existingReps) { bestPRsMap.set(key, pr); }
                }
            }
            const finalNewPRs = Array.from(bestPRsMap.values());
            
            // Use setTimeout to allow spinner to render
            setTimeout(() => {
                if (finalNewPRs.length > 0) {
                    state.pendingWorkout = workout;
                    state.pendingPRs = finalNewPRs;
                    showNextPR();
                } else {
                    state.workouts = [...state.workouts, workout];
                    localStorage.setItem('workouts', JSON.stringify(state.workouts));
                    checkAndAwardBadges(workout);
                    state.currentSets = []; state.selectedCalendarDate = null; 
                    state.liveSetIndex = 0; // Reset live index
                    alert('ðŸŽ‰ Workout saved!');
                    state.isFinishing = false;
                    state.view = 'home';
                    render(); // Render *after* badge check
                }
            }, 100); // 100ms delay
        }

        // Check PR (Manual)
        function checkPR(exerciseName, weight, reps) { /* ... unchanged ... */ }
        // Share PR
        function sharePR(pr) {
            const msg = `ðŸŽ‰ New PR! ${state.userName || 'I'} just hit ${pr.weight} ${pr.unit}${pr.reps ? ` Ã— ${pr.reps}` : ''} on ${pr.exercise}! ðŸ’ª`;
            if (navigator.share) {
                navigator.share({
                    title: 'New Personal Record!',
                    text: msg,
                    url: window.location.href
                }).catch(err => console.log('Error sharing', err));
            } else {
                window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        // Save PR
        function savePR(share) {
            if (!state.prData) return;
            const newPR = {
                id: Date.now(), userName: state.userName || 'Anonymous', exercise: state.prData.exercise,
                weight: state.prData.weight, reps: state.prData.reps, unit: state.unit, date: new Date().toISOString()
            };
            state.prs = state.prs.filter(pr => pr.exercise !== newPR.exercise || pr.weight > newPR.weight || (pr.weight === newPR.weight && pr.reps > newPR.reps));
            state.prs.push(newPR);
            localStorage.setItem('prs', JSON.stringify(state.prs));
            if (share) { sharePR(newPR); }
            
            state.showPRDialog = false; state.prData = null;
            
            if (state.pendingWorkout) {
                showNextPR();
            } else {
                render(); // This was a manual check, just re-render
            }
        }

        // Delete PR
        function deletePR(id) {
            if (confirm('Are you sure you want to delete this PR?')) {
                state.prs = state.prs.filter(pr => pr.id !== id);
                localStorage.setItem('prs', JSON.stringify(state.prs));
                render();
            }
        }
        // Share Workout
        function shareWorkout(workout) { /* ... unchanged ... */ }

        // Get Streak
        function getStreak() {
            if (state.workouts.length === 0) return 0;
            const dates = [...new Set(state.workouts.map(w => new Date(w.date).toDateString()))];
            dates.sort((a, b) => new Date(b) - new Date(a));
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(today.getDate() - 1);
            const latestWorkoutDate = new Date(dates[0]);
            if (latestWorkoutDate.toDateString() !== today.toDateString() && latestWorkoutDate.toDateString() !== yesterday.toDateString()) {
                return 0; // Streak is broken
            }
            let streak = 1;
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i-1]);
                const currDate = new Date(dates[i]);
                const expectedDate = new Date(prevDate);
                expectedDate.setDate(prevDate.getDate() - 1);
                if (currDate.toDateString() === expectedDate.toDateString()) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        // Share Streak
        function shareStreak() { /* ... unchanged ... */ }
        // Save User Name
        function saveUserName() {
            localStorage.setItem('userName', state.userName);
            localStorage.setItem('gender', state.gender);
            localStorage.setItem('age', state.age);
            localStorage.setItem('bodyweight', state.bodyweight);
            state.showNameDialog = false;
            render();
        }
        // Delete Workout
        function deleteWorkout(id) { /* ... unchanged ... */ }
        // Get Progress Data
        function getProgressData(exerciseName) { /* ... unchanged ... */ return []; }

        // Calendar Functions
        function getDaysInMonth(month, year) { return new Date(year, month + 1, 0).getDate(); }
        function getFirstDayOfMonth(month, year) { return new Date(year, month, 1).getDay(); }
        function getWorkoutDates() { return new Set(state.workouts.map(w => new Date(w.date).toISOString().split('T')[0])); }
        
        // --- FIX: Implemented Calendar Helper Functions ---
        function getPlanDates() { 
            return state.plans; 
        }
        function changeMonth(delta) {
            state.calendarMonth += delta;
            if (state.calendarMonth > 11) { state.calendarMonth = 0; state.calendarYear++; }
            else if (state.calendarMonth < 0) { state.calendarMonth = 11; state.calendarYear--; }
            render();
        }
        function selectCalendarDay(dateString) { state.selectedCalendarDate = dateString; state.showCalendarModal = true; resetPlanForm(); render(); }
        
        // --- FIX: Implemented Calendar Helper Functions ---
        function resetPlanForm() {
            state.planType = 'activity';
            state.planActivityType = 'strength';
            state.planStrengthExercise = 'squat';
            state.planCardioExercise = 'run';
            state.planCardioDuration = '';
            state.planNotes = '';
            state.planRoutineId = '';
        }
        function closeCalendarModal() { state.showCalendarModal = false; state.selectedCalendarDate = null; resetPlanForm(); render(); }
        
        // --- FIX: Implemented savePlan function ---
        function savePlan() {
            if (!state.selectedCalendarDate) return;

            const plansForDate = state.plans[state.selectedCalendarDate] || [];
            let newPlan = {
                id: Date.now().toString(),
                type: state.planType,
                activityName: '',
                details: {}
            };

            if (state.planType === 'routine') {
                if (!state.planRoutineId) {
                    alert('Please select a routine.');
                    return;
                }
                const routine = state.routines.find(r => r.id == state.planRoutineId);
                if (!routine) {
                    alert('Selected routine not found.');
                    return;
                }
                newPlan.activityName = routine.name;
                newPlan.details = { 
                    routineId: state.planRoutineId,
                    notes: state.planNotes 
                };
            } else { // 'activity'
                if (state.planActivityType === 'strength') {
                    newPlan.activityName = exercises[state.planStrengthExercise];
                    newPlan.details = {
                        type: 'strength',
                        exercise: newPlan.activityName,
                        notes: state.planNotes
                    };
                } else { // 'cardio'
                    if (!state.planCardioDuration) {
                        alert('Please enter a duration for cardio.');
                        return;
                    }
                    newPlan.activityName = cardioExercises[state.planCardioExercise];
                    newPlan.details = {
                        type: 'cardio',
                        exercise: newPlan.activityName,
                        duration: state.planCardioDuration,
                        notes: state.planNotes
                    };
                }
            }

            state.plans[state.selectedCalendarDate] = [...plansForDate, newPlan];
            localStorage.setItem('plans', JSON.stringify(state.plans));
            resetPlanForm();
            render(); // Re-render to show the new plan in the modal
        }
        
        // --- FIX: Implemented deletePlan function ---
        function deletePlan(planId) {
            if (!state.selectedCalendarDate || !state.plans[state.selectedCalendarDate]) return;
            
            if (confirm('Are you sure you want to delete this plan?')) {
                state.plans[state.selectedCalendarDate] = state.plans[state.selectedCalendarDate].filter(p => p.id !== planId);
                if (state.plans[state.selectedCalendarDate].length === 0) {
                    delete state.plans[state.selectedCalendarDate];
                }
                localStorage.setItem('plans', JSON.stringify(state.plans));
                render(); // Re-render the modal
            }
        }
        
        // --- FIX: Implemented logForSelectedDate function ---
        function logForSelectedDate() {
            // Use selectedCalendarDate if available, otherwise default to today
            const dateToLog = state.selectedCalendarDate || new Date().toISOString().split('T')[0];
            const plans = state.plans[dateToLog] || [];
            
            if (plans.length > 0) {
                let setsToLoad = [];
                plans.forEach(plan => {
                    if (plan.type === 'routine') {
                        const routine = state.routines.find(r => r.id == plan.details.routineId);
                        if (routine) {
                            // Deep copy activities
                            const routineActivities = JSON.parse(JSON.stringify(routine.activities));
                            routineActivities.forEach((act, idx) => {
                                act.id = Date.now() + setsToLoad.length + idx; // Ensure unique ID
                            });
                            setsToLoad = [...setsToLoad, ...routineActivities];
                        }
                    } else if (plan.type === 'activity') {
                        if (plan.details.type === 'strength') {
                            setsToLoad.push({
                                id: Date.now() + setsToLoad.length,
                                type: 'strength',
                                exercise: plan.details.exercise,
                                weight: '', // User needs to fill this
                                reps: '',   // User needs to fill this
                                unit: state.unit // Default unit
                            });
                        } else if (plan.details.type === 'cardio') {
                            setsToLoad.push({
                                id: Date.now() + setsToLoad.length,
                                type: 'cardio',
                                exercise: plan.details.exercise,
                                duration: plan.details.duration
                            });
                        }
                    }
                });
                state.currentSets = setsToLoad;
            } else {
                // No plans, just start an empty log for that day
                state.currentSets = [];
            }
            
            state.view = 'log';
            // Set the date for the log tab
            state.selectedCalendarDate = dateToLog;
            
            // Manually close modal and reset state
            state.showCalendarModal = false; 
            resetPlanForm(); 
            
            render();
        }

        // Routines Functions
        function addActivityToRoutine() { /* ... unchanged ... */ }
        function saveRoutine() { /* ... unchanged ... */ }
        function deleteRoutine(id) {
            if (id <= 1010) { alert('Default routines cannot be deleted.'); return; }
            if (confirm('Are you sure you want to delete this routine?')) {
                state.routines = state.routines.filter(r => r.id !== id);
                localStorage.setItem('routines', JSON.stringify(state.routines));
                render();
            }
        }
        
        function showRoutinePreview(routineId) {
            state.previewRoutineId = routineId;
            state.showRoutinePreview = true;
            render();
        }
        
        function closeRoutinePreview() {
            state.showRoutinePreview = false;
            state.previewRoutineId = null;
            render();
        }
        
        function startRoutineFromPreview() {
            if (state.previewRoutineId) {
                loadRoutine(state.previewRoutineId);
                state.showRoutinePreview = false;
                state.previewRoutineId = null;
            }
        }
        
        function loadRoutine(routineId, clearSelectedDate = true) {
            const routine = state.routines.find(r => r.id == routineId);
            if (!routine) {
                alert('Routine not found!');
                return;
            }
            
            // Clear any existing calendar date selection if needed
            if (clearSelectedDate) {
                state.selectedCalendarDate = null;
            }
            
            // Copy activities to current sets
            state.currentSets = routine.activities.map((a, idx) => ({
                ...a,
                id: Date.now() + idx,
                weight: a.weight || '',
                reps: a.reps || '',
                unit: a.unit || state.unit
            }));
            
            // Switch to log view
            state.view = 'log';
            render();
        }

        // Render Calendar
        function renderCalendar() {
             const daysInMonth = getDaysInMonth(state.calendarMonth, state.calendarYear);
            const firstDay = getFirstDayOfMonth(state.calendarMonth, state.calendarYear);
            const workoutDates = getWorkoutDates();
            const planDates = getPlanDates();
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return `
                <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                    <div class="flex items-center justify-between mb-6">
                        <button onclick="changeMonth(-1)" class="glass hover:glass-strong px-4 py-2 rounded-lg">â†</button>
                        <h3 class="text-xl font-bold">${monthNames[state.calendarMonth]} ${state.calendarYear}</h3>
                        <button onclick="changeMonth(1)" class="glass hover:glass-strong px-4 py-2 rounded-lg">â†’</button>
                    </div>
                    <div class="grid grid-cols-7 gap-2 mb-2">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => 
                            `<div class="text-center text-sm text-gray-400 font-semibold">${day}</div>`
                        ).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-2">
                        ${Array(firstDay).fill(null).map(() => `<div class="calendar-day"></div>`).join('')}
                        ${Array(daysInMonth).fill(null).map((_, i) => {
                            const day = i + 1; const date = new Date(state.calendarYear, state.calendarMonth, day);
                            const dateString = date.toISOString().split('T')[0];
                            const hasWorkout = workoutDates.has(dateString); 
                            // --- FIX: Use planDates correctly ---
                            const planInfo = planDates[dateString] || [];
                            const planType = planInfo.length > 0 ? planInfo[0].type : null; // Just show first plan type
                            const isToday = new Date().toISOString().split('T')[0] === dateString;
                            let dayClass = 'glass';
                            if (hasWorkout) { dayClass = 'bg-green-600'; }
                            // --- FIX: Check planInfo.length ---
                            else if (planInfo.length > 0) { 
                                // Simple logic: show purple if any strength, blue if only cardio
                                if (planInfo.some(p => (p.type === 'activity' && p.details.type === 'strength') || p.type === 'routine')) {
                                    dayClass = 'bg-purple-600';
                                } else {
                                    dayClass = 'bg-blue-600';
                                }
                            }
                            return `
                                <div onclick="selectCalendarDay('${dateString}')" 
                                     class="calendar-day rounded-lg ${dayClass} ${isToday ? 'ring-2 ring-blue-400' : ''} hover:glass-strong transition">
                                    <span class="text-sm ${hasWorkout || planInfo.length > 0 ? 'font-bold' : ''}">${day}</span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    <div class="mt-6 flex flex-wrap items-center justify-center gap-4 text-sm">
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-green-600"></div><span class="text-gray-400">Logged</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-purple-600"></div><span class="text-gray-400">Planned Strength</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-blue-600"></div><span class="text-gray-400">Planned Cardio</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded glass"></div><span class="text-gray-400">Rest Day</span></div>
                    </div>
                </div>
            `;
        }

        // Modal Handlers
        function handlePlanTypeChange(type) { state.planType = type; render(); }
        function handlePlanActivityTypeChange(type) { state.planActivityType = type; render(); }

        // Chart Rendering
        let chartInstances = {};
        function renderCharts() { /* ... unchanged ... */ }
        // (Full renderCharts function omitted for brevity, it is unchanged)

        // Live Workout Functions
        function startLiveWorkout() {
            state.view = 'live'; state.isResting = false;
            if (state.restTimerId) clearInterval(state.restTimerId);
            state.restTimerId = null; render();
        }
        function stopRestTimer() {
            if (state.restTimerId) clearInterval(state.restTimerId);
            state.restTimerId = null; state.isResting = false; render();
        }
        function logLiveSet() {
            const currentSet = state.currentSets[state.liveSetIndex];
            if (currentSet.type === 'strength') {
                const weightInput = document.getElementById('liveWeightInput');
                const repsInput = document.getElementById('liveRepsInput');
                if (weightInput && repsInput) { currentSet.weight = weightInput.value; currentSet.reps = repsInput.value; }
            }
            state.liveSetIndex++;
            if (state.liveSetIndex >= state.currentSets.length) {
                state.isResting = false;
                if (state.restTimerId) clearInterval(state.restTimerId);
                state.restTimerId = null;
            } else {
                state.isResting = true; state.restTimerRemaining = state.restDuration;
                state.restTimerId = setInterval(() => {
                    state.restTimerRemaining--;
                    if (state.restTimerRemaining <= 0) {
                        clearInterval(state.restTimerId); state.restTimerId = null; state.isResting = false;
                        if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                        render();
                    } else {
                        render();
                    }
                }, 1000);
            }
            render();
        }
        // --- NEW: Pause Workout ---
        function pauseWorkout() {
            state.view = 'log';
            if (state.restTimerId) clearInterval(state.restTimerId); // Stop timer if active
            state.restTimerId = null;
            state.isResting = false;
            render();
        }

        // Home Dashboard
        function renderHome() { /* ... unchanged ... */ 
             const levelInfo = calculateLevel();
            const today = new Date().toISOString().split('T')[0];
            const plansToday = state.plans[today] || [];
            const onThisDayWorkouts = state.workouts.filter(w => {
                const wDate = new Date(w.date); const todayDate = new Date();
                return wDate.getDate() === todayDate.getDate() &&
                       wDate.getMonth() === todayDate.getMonth() &&
                       wDate.getFullYear() !== todayDate.getFullYear();
            });
            return `
                <div class="space-y-6 fade-in">
                    <div class="glass-strong rounded-3xl p-6 text-center">
                        <h2 class="text-2xl font-bold">Welcome back, ${state.userName || 'Lifter'}!</h2>
                        <button onclick="state.showNameDialog = true; render();" class="text-sm text-blue-400 hover:text-blue-300">
                            ${state.userName ? 'Change Name' : 'Set Your Name'}
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="glass-strong rounded-3xl p-6 text-center hover-lift">
                            <div class="text-5xl">ðŸ”¥</div>
                            <div class="text-3xl font-bold mt-2">${getStreak()}</div>
                            <div class="text-sm text-gray-400">Day Streak</div>
                        </div>
                        <div class="glass-strong rounded-3xl p-6 text-center hover-lift">
                            <div class="text-5xl">LVL</div>
                            <div class="text-3xl font-bold mt-2">${levelInfo.level}</div>
                            <div class="text-sm text-gray-400">Your Level</div>
                        </div>
                    </div>
                    <div class="glass-strong rounded-3xl p-6 hover-lift">
                        <h3 class="font-semibold mb-3">Level ${levelInfo.level} Progress</h3>
                        <div class="w-full glass rounded-full h-4 mb-1">
                            <div class="h-4 rounded-full progress-animated" style="width: ${levelInfo.progressPercent}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 text-right">${state.xp.toLocaleString()} / ${levelInfo.nextLevelXp.toLocaleString()} XP</div>
                    </div>
                    ${plansToday.length > 0 ? `
                        <div class="glass-strong rounded-3xl p-6 hover-lift">
                            <h3 class="text-xl font-bold mb-4">Today's Plan</h3>
                            <div class="space-y-2 mb-4">
                                ${plansToday.map(plan => `
                                    <div class="glass rounded-lg p-3">
                                        <div class="font-semibold">${plan.activityName}</div>
                                        <div class="text-sm text-gray-400">
                                            ${plan.type === 'routine' ? 'Routine' :
                                              plan.type === 'strength' ? (plan.details.notes || 'Strength') :
                                              `${plan.details.duration} min Cardio`}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <button onclick="logForSelectedDate()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                                ðŸ“ Start Today's Workout
                            </button>
                        </div>
                    ` : `
                        <div class="glass-strong rounded-3xl p-6 hover-lift text-center">
                            <h3 class="text-xl font-bold mb-3">Ready to train?</h3>
                            <p class="text-gray-400 text-sm mb-4">No workout planned for today. Log one now!</p>
                            <button onclick="state.view = 'log'; state.selectedCalendarDate = null; render();" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                                ðŸ“ Log a Workout
                            </button>
                        </div>
                    `}
                    ${onThisDayWorkouts.length > 0 ? `
                        <div class="glass-strong rounded-3xl p-6 hover-lift">
                            <h3 class="text-xl font-bold mb-4">On This Day...</h3>
                            ${onThisDayWorkouts.map(w => {
                                const activities = w.activities || w.sets || [];
                                return `
                                <div class="glass rounded-xl p-3 mb-2">
                                    <div class="font-semibold text-purple-400 mb-1">${new Date(w.date).getFullYear()}</div>
                                    <p class="text-sm text-gray-400">${activities.length} activities logged
                                    ${w.volume > 0 ? ` â€¢ ${w.volume.toLocaleString()} ${state.unit} vol` : ''}</p>
                                </div>
                                `
                            }).join('')}
                        </div>
                    ` : ''}
                    <div class="glass-strong rounded-3xl p-6 hover-lift">
                        <h3 class="text-xl font-bold mb-4">ðŸ† Badges Unlocked</h3>
                        ${state.badges.length === 0 ? `
                            <p class="text-gray-400 text-sm">Keep training to unlock badges!</p>
                        ` : `
                            <div class="grid grid-cols-3 gap-4">
                                ${state.badges.slice(0, 5).map(badgeId => { // Show first 5
                                    const badge = badgeData[badgeId];
                                    if (!badge) return '';
                                    return `
                                    <div class="glass rounded-xl p-4 text-center" title="${badge.desc}">
                                        <div class="text-4xl">${badge.icon}</div>
                                        <div class="text-xs font-semibold mt-2">${badge.title}</div>
                                    </div>
                                    `
                                }).join('')}
                                <button onclick="state.view = 'badges'; render();" class="glass rounded-xl p-4 text-center flex flex-col items-center justify-center text-blue-400 hover:glass-strong">
                                    <span class="text-2xl">...</span>
                                    <span class="text-xs font-semibold mt-2">View All</span>
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Live Workout
        function renderLive() {
            if (state.isResting) {
                const nextSet = state.currentSets[state.liveSetIndex];
                return `
                    <div class="fixed inset-0 bg-animated flex flex-col items-center justify-center p-6 text-center fade-in">
                        <div class="text-sm text-gray-400 mb-2">RESTING</div>
                        <div class="text-9xl font-bold">${state.restTimerRemaining}</div>
                        <div class="mt-8 glass-strong rounded-2xl p-4 w-full max-w-md">
                            <div class="text-sm text-gray-400 mb-2">Next Up:</div>
                            ${nextSet ? `
                                <div class="font-semibold text-xl">${nextSet.exercise}</div>
                                ${nextSet.type === 'strength' ? 
                                    `<div class="text-gray-300">${nextSet.weight || '...'} ${nextSet.unit} Ã— ${nextSet.reps || '...'}</div>` : 
                                    `<div class="text-gray-300">${nextSet.duration} min</div>`}
                            ` : ''}
                        </div>
                        <button onclick="stopRestTimer()" class="mt-6 glass hover:glass-strong px-6 py-3 rounded-lg font-semibold transition">
                            Skip Rest
                        </button>
                    </div>
                `;
            }
            const set = state.currentSets[state.liveSetIndex];
            if (!set) {
                return `
                    <div class="fixed inset-0 bg-animated flex flex-col items-center justify-center p-6 text-center fade-in space-y-6">
                        <div class="text-5xl">ðŸŽ‰</div>
                        <h2 class="text-3xl font-bold">Workout Complete!</h2>
                        <p class="text-gray-400">You finished all ${state.currentSets.length} activities.</p>
                        <button onclick="finishWorkout()" class="w-full max-w-md bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green py-4 rounded-lg font-semibold transition flex items-center justify-center gap-3">
                            ${state.isFinishing ? '<div class="spinner"></div> Finishing...' : 'âœ… Finish & Save Workout'}
                        </button>
                    </div>
                `;
            }
            return `
                <div class="fixed inset-0 bg-animated flex flex-col justify-between p-6 fade-in">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <div class="text-sm text-green-400 font-semibold">
                                ACTIVITY ${state.liveSetIndex + 1} / ${state.currentSets.length}
                            </div>
                            <div class="flex gap-4">
                                <button onclick="state.showTimerModal = true; render();" class="text-2xl">âš™ï¸</button>
                                <button onclick="pauseWorkout()" class="text-sm text-yellow-400 hover:text-yellow-300">Pause Workout</button>
                            </div>
                        </div>
                        <div class="glass-strong rounded-3xl p-6">
                            <h2 class="text-3xl font-bold mb-4">${set.exercise}</h2>
                            ${set.type === 'strength' ? `
                                <div class="space-y-4">
                                    <input type="number" id="liveWeightInput" value="${set.weight}" placeholder="Weight (${set.unit})" class="w-full glass text-white text-2xl rounded-lg px-4 py-3">
                                    <input type="number" id="liveRepsInput" value="${set.reps}" placeholder="Reps" class="w-full glass text-white text-2xl rounded-lg px-4 py-3">
                                </div>
                            ` : `
                                <p class="text-2xl text-gray-300">Duration: ${set.duration} minutes</p>
                            `}
                        </div>
                    </div>
                    <button onclick="logLiveSet()" class="w-full btn-primary hover-scale transition-all ripple py-4 rounded-lg font-semibold text-lg transition">
                        Log ${set.type === 'strength' ? 'Set' : 'Activity'}
                    </button>
                </div>
            `;
        }
        
        // --- NEW: Render Badges Tab ---
        function renderBadges() {
            return `
                <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                    <h3 class="text-xl font-bold mb-6">ðŸ† Badge Collection</h3>
                    <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-4">
                        ${Object.keys(badgeData).map(badgeId => {
                            const badge = badgeData[badgeId];
                            const earned = state.badges.includes(badgeId);
                            return `
                            <div class="glass rounded-xl p-4 text-center ${earned ? '' : 'opacity-40 grayscale'}">
                                <div class="text-5xl">${badge.icon}</div>
                                <div class="text-sm font-semibold mt-2 ${earned ? 'text-yellow-400' : ''}">${badge.title}</div>
                                <div class="text-xs text-gray-400 mt-1">${badge.desc}</div>
                            </div>
                            `
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // --- Main Render Function ---
        function render() {
            const app = document.getElementById('app');
            
            function renderActivity(a, idx, listName) {
                if (listName === 'currentSets') {
                    if (a.type === 'strength') {
                        return `
                            <div class="glass-strong rounded-lg p-3 mb-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold">${a.exercise}</span>
                                    <button onclick="state.currentSets.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                                </div>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" value="${a.weight}" oninput="state.currentSets[${idx}].weight = this.value" placeholder="Weight (${a.unit})" class="glass text-white rounded-lg px-3 py-2 text-sm">
                                    <input type="number" value="${a.reps}" oninput="state.currentSets[${idx}].reps = this.value" placeholder="Reps" class="glass text-white rounded-lg px-3 py-2 text-sm">
                                </div>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="glass-strong rounded-lg p-3 mb-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-semibold">${a.exercise}</span>
                                    <button onclick="state.currentSets.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                                </div>
                                <input type="number" value="${a.duration}" oninput="state.currentSets[${idx}].duration = this.value" placeholder="Duration (min)" class="w-full glass text-white rounded-lg px-3 py-2 text-sm">
                            </div>
                        `;
                    }
                } else { // For Routines tab
                    if (a.type === 'strength') {
                        return `
                            <div class="flex items-center justify-between glass-strong rounded-lg p-3 mb-2">
                                <div>
                                    <span class="font-semibold">${a.exercise}</span>
                                    <span class="text-gray-400 ml-2">${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</span>
                                </div>
                                <button onclick="state.${listName}.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                            </div>
                        `;
                    } else {
                        return `
                            <div class="flex items-center justify-between glass-strong rounded-lg p-3 mb-2">
                                <div>
                                    <span class="font-semibold">${a.exercise}</span>
                                    <span class="text-gray-400 ml-2">${a.duration} min</span>
                                </div>
                                <button onclick="state.${listName}.splice(${idx}, 1); render();" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                            </div>
                        `;
                    }
                }
            }

            // Main App Shell
            app.innerHTML = `
                ${state.view === 'live' ? '' : `
                    <div class="text-center mb-6 pt-6">
                        <div class="flex items-center justify-center gap-3 mb-2">
                            <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <h1 class="text-4xl font-bold">Rocko's Modern Gym App</h1>
                        </div>
                        <p class="text-gray-400">Your complete strength training companion</p>
                    </div>

                    <div class="grid grid-cols-4 md:grid-cols-8 gap-1 mb-6 glass-strong p-2 rounded-xl">
                        <button onclick="state.view = 'home'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'home' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ </span><span class="text-xs">Home</span>
                        </button>
                        <button onclick="state.view = 'log'; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'log' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ“</span><span class="text-xs">Log</span>
                        </button>
                        <button onclick="state.view = 'cal'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'cal' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ“…</span><span class="text-xs">Calendar</span>
                        </button>
                        <button onclick="state.view = 'routines'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'routines' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ““</span><span class="text-xs">Routines</span>
                        </button>
                        <button onclick="state.view = 'prog'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'prog' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ“ˆ</span><span class="text-xs">Progress</span>
                        </button>
                        <button onclick="state.view = 'prs'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'prs' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ†</span><span class="text-xs">PRs</span>
                        </button>
                        <button onclick="state.view = 'badges'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'badges' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ…</span><span class="text-xs">Badges</span>
                        </button>
                        <button onclick="state.view = 'calc'; state.selectedCalendarDate = null; render();" class="py-3 rounded-lg font-semibold flex flex-col items-center gap-1 transition ${state.view === 'calc' ? 'bg-blue-600' : 'text-gray-400 hover:glass'}">
                            <span>ðŸ’ª</span><span class="text-xs">Calc</span>
                        </button>
                    </div>
                `}

                ${state.view === 'home' ? renderHome() : ''}
                ${state.view === 'live' ? renderLive() : ''}
                ${state.view === 'badges' ? renderBadges() : ''}

                ${state.view === 'calc' ? `
                    <div class="space-y-6">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                            <h3 class="text-xl font-bold mb-4">Strength Standards</h3>
                            <div class="flex gap-2 mb-4">
                                <button onclick="state.unit = 'lbs'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'lbs' ? 'bg-blue-600' : 'glass hover:glass-strong'}">LBS</button>
                                <button onclick="state.unit = 'kg'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'kg' ? 'bg-blue-600' : 'glass hover:glass-strong'}">KG</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <select onchange="state.exercise = this.value; render();" class="glass text-white rounded-lg px-4 py-3">
                                    ${['squat', 'bench', 'deadlift', 'ohp', 'row'].map(ex => `<option value="${ex}" ${state.exercise === ex ? 'selected' : ''}>${exercises[ex]}</option>`).join('')}
                                </select>
                                <select onchange="state.gender = this.value; render();" class="glass text-white rounded-lg px-4 py-3">
                                    <option value="male" ${state.gender === 'male' ? 'selected' : ''}>Male</option>
                                    <option value="female" ${state.gender === 'female' ? 'selected' : ''}>Female</option>
                                </select>
                            </div>
                            <select onchange="state.category = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                <option value="natural" ${state.category === 'natural' ? 'selected' : ''}>Natural Lifter</option>
                                <option value="enhanced" ${state.category === 'enhanced' ? 'selected' : ''}>Enhanced Lifter</option>
                            </select>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="number" value="${state.bodyweight}" oninput="state.bodyweight = this.value;" placeholder="Your bodyweight (${state.unit})" class="w-full glass text-white rounded-lg px-4 py-3">
                                <input type="number" value="${state.strengthWeight}" oninput="state.strengthWeight = this.value;" placeholder="Weight Lifted (${state.unit})" class="w-full glass text-white rounded-lg px-4 py-3">
                            </div>
                            <button onclick="handleCalculateStrength()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">Calculate Strength</button>
                            ${state.strengthResult ? `
                                <div class="glass rounded-xl p-6">
                                    <div class="text-center mb-4">
                                        <div class="text-3xl font-bold ${levelColors[state.strengthResult.level]} capitalize mb-2">${state.strengthResult.level}</div>
                                        <div class="text-gray-400 text-sm">${state.strengthResult.ratio}x Bodyweight</div>
                                    </div>
                                    
                                    <!-- Visual Strength Standards Chart -->
                                    <div class="mb-6">
                                        <canvas id="strengthChart" width="400" height="150"></canvas>
                                    </div>
                                    
                                    ${state.strengthResult.level !== 'elite' ? `
                                        <div class="mb-4">
                                            <div class="flex justify-between text-xs text-gray-400 mb-2"><span>Progress to ${state.strengthResult.nextLevel}</span><span>${state.strengthResult.progress}%</span></div>
                                            <div class="w-full glass rounded-full h-3"><div class="h-3 rounded-full ${levelBgColors[state.strengthResult.level]} transition-all duration-500" style="width: ${state.strengthResult.progress}%"></div></div>
                                        </div>
                                        ${state.strengthResult.nextWeight ? `<div class="text-center text-sm"><span class="text-gray-400">Next milestone:</span><span class="text-white font-bold text-lg ml-2">${state.strengthResult.nextWeight} ${state.unit}</span></div>` : ''}
                                    ` : `<div class="text-center text-green-400 font-semibold">ðŸ† Maximum Level Achieved!</div>`}
                                </div>
                            ` : ''}
                        </div>
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                            <h3 class="text-xl font-bold mb-4">1RM Calculator</h3>
                            <div class="flex gap-2 mb-4">
                                <button onclick="state.unit = 'lbs'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'lbs' ? 'bg-blue-600' : 'glass hover:glass-strong'}">LBS</button>
                                <button onclick="state.unit = 'kg'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'kg' ? 'bg-blue-600' : 'glass hover:glass-strong'}">KG</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <input type="number" value="${state.repWeight}" oninput="state.repWeight = this.value;" placeholder="Weight (${state.unit})" class="glass text-white rounded-lg px-4 py-3">
                                <input type="number" value="${state.reps}" oninput="state.reps = this.value;" placeholder="Reps (1-12)" class="glass text-white rounded-lg px-4 py-3">
                            </div>
                            <button onclick="handleCalculate1RM()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">Calculate 1RM</button>
                            ${state.oneRMResult ? `
                                <div class="glass rounded-xl p-6">
                                    <div class="text-center mb-6"><div class="text-sm text-gray-400 mb-2">Estimated 1 Rep Max</div><div class="text-5xl font-bold text-green-400">${state.oneRMResult.avg}</div><div class="text-sm text-gray-400 mt-1">${state.unit}</div></div>
                                    <div class="grid grid-cols-2 gap-3">
                                        ${[95, 90, 85, 80, 75, 70, 65, 60].map(pct => `<div class="glass-strong rounded-lg px-4 py-3 flex justify-between items-center"><span class="text-gray-400 font-semibold">${pct}%</span><span class="text-white font-bold">${state.oneRMResult.percentages[pct]}</span></div>`).join('')}
                                    </div>
                                </div>
                            ` : `<div class="text-center text-gray-400 py-6">Enter weight and reps (1-12) to calculate your 1RM</div>`}
                        </div>
                        <div class="glass-strong rounded-2xl shadow-2xl p-6">
                            <h3 class="text-xl font-bold mb-4">Plate Calculator</h3>
                            <div class="flex gap-2 mb-6">
                                <button onclick="state.unit = 'lbs'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'lbs' ? 'bg-blue-600' : 'glass hover:glass-strong'}">LBS</button>
                                <button onclick="state.unit = 'kg'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.unit === 'kg' ? 'bg-blue-600' : 'glass hover:glass-strong'}">KG</button>
                            </div>
                            <select onchange="state.bar = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-6">
                                ${Object.entries(barNames).map(([key, name]) => `<option value="${key}" ${state.bar === key ? 'selected' : ''}>${name}</option>`).join('')}
                            </select>
                            <input type="number" value="${state.weight}" oninput="state.weight = this.value;" placeholder="Enter target weight (${state.unit})" class="w-full glass text-white text-2xl rounded-lg px-4 py-3 mb-6">
                            <button onclick="handleCalculatePlates()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">Calculate Plates</button>
                            ${state.plateResult && state.plateResult.plates ? `
                                <div class="glass rounded-xl p-6">
                                    ${state.plateResult.error ? `<p class="text-yellow-400 text-sm mb-4 text-center font-semibold">${state.plateResult.error}</p>` : ''}
                                    <h4 class="text-xl font-bold mb-4 text-center">Load per side:</h4>
                                    <div class="space-y-3">
                                        ${state.plateResult.plates.map(p => `<div class="flex items-center justify-between glass-strong rounded-xl p-4 hover-scale transition-all"><span class="text-2xl font-bold text-blue-400">${p.weight} ${state.unit}</span><span class="text-xl text-gray-300">Ã— ${p.count}</span></div>`).join('')}
                                    </div>
                                </div>
                            ` : state.plateResult && state.plateResult.error ? `<div class="glass rounded-xl p-6 text-center"><p class="text-yellow-400">${state.plateResult.error}</p></div>` : ''}
                        </div>
                    </div>
                ` : ''}

                ${state.view === 'log' ? `
                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                        ${state.selectedCalendarDate ?
                            `<div class="bg-yellow-600 text-black text-center font-bold p-3 rounded-lg mb-4 flex justify-between items-center">
                                <span>Logging for: ${new Date(state.selectedCalendarDate + 'T12:00:00').toLocaleDateString()}</span>
                                <button onclick="state.selectedCalendarDate = null; render();" class="text-sm bg-black/20 px-2 py-1 rounded hover:bg-black/40">Log for Today</button>
                            </div>` :
                            `<h3 class="text-xl font-bold mb-4">Log Workout</h3>`
                        }
                        ${state.routines.length > 0 ? `
                            <select onchange="if (this.value) { showRoutinePreview(this.value); this.value = ''; }" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                <option value="">--- Load a Saved Routine ---</option>
                                ${state.routines.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                            </select>
                        ` : ''}
                        ${state.currentSets.length > 0 ? `
                            <div class="mb-6 glass rounded-xl p-4">
                                <h4 class="font-semibold mb-3 text-green-400">Current Workout</h4>
                                ${state.currentSets.map((a, idx) => renderActivity(a, idx, 'currentSets')).join('')}
                                
                                ${state.liveSetIndex > 0 ? `
                                    <button onclick="state.view = 'live'; render();" class="w-full bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 hover-scale transition-all ripple glow-purple py-3 rounded-lg font-semibold mt-3 transition">
                                        ðŸš€ Resume Workout
                                    </button>
                                ` : `
                                    <button onclick="startLiveWorkout()" class="w-full bg-gradient-to-r from-purple-500 to-blue-600 hover:from-purple-600 hover:to-blue-700 hover-scale transition-all ripple glow-purple py-3 rounded-lg font-semibold mt-3 transition">
                                        ðŸš€ Start Live Workout
                                    </button>
                                `}
                                <button onclick="finishWorkout()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green py-3 rounded-lg font-semibold mt-3 transition flex items-center justify-center gap-3">
                                    ${state.isFinishing ? '<div class="spinner"></div> Finishing...' : 'âœ… Finish Workout'}
                                </button>
                            </div>
                        ` : ''}
                        <div class="flex gap-2 mb-4">
                            <button onclick="state.logActivityType = 'strength'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.logActivityType === 'strength' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸ‹ï¸â€â™‚ï¸ Strength</button>
                            <button onclick="state.logActivityType = 'cardio'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.logActivityType === 'cardio' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸƒâ€â™‚ï¸ Cardio</button>
                        </div>
                        ${state.logActivityType === 'strength' ? `
                            <select onchange="state.workoutExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                ${Object.entries(exercises).map(([key, name]) => `<option value="${key}" ${state.workoutExercise === key ? 'selected' : ''}>${name}</option>`).join('')}
                            </select>
                            <div class="grid grid-cols-3 gap-4 mb-4">
                                <input type="number" value="${state.workoutWeight}" oninput="state.workoutWeight = this.value" placeholder="Weight" class="glass text-white rounded-lg px-4 py-3">
                                <input type="number" value="${state.workoutReps}" oninput="state.workoutReps = this.value" placeholder="Reps" class="glass text-white rounded-lg px-4 py-3">
                                <input type="number" value="${state.workoutSets}" oninput="state.workoutSets = this.value" placeholder="Sets" class="glass text-white rounded-lg px-4 py-3">
                            </div>
                        ` : `
                            <select onchange="state.workoutCardioExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                ${Object.entries(cardioExercises).map(([key, name]) => `<option value="${key}" ${state.workoutCardioExercise === key ? 'selected' : ''}>${name}</option>`).join('')}
                            </select>
                            <input type="number" value="${state.workoutCardioDuration}" oninput="state.workoutCardioDuration = this.value" placeholder="Duration (minutes)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                        `}
                        <button onclick="addActivity()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                            âž• Add Activity
                        </button>
                    </div>
                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                        <h3 class="text-xl font-bold mb-4">Recent Workouts</h3>
                        ${state.workouts.length === 0 ? `
                            <div class="text-center py-12"><p class="text-gray-400 text-lg mb-2">No workouts logged yet!</p><p class="text-gray-500 text-sm">Start tracking your progress above</p></div>
                        ` : state.workouts.slice().reverse().slice(0, 10).map(w => {
                            const activities = w.activities || w.sets || [];
                            return `
                            <div class="glass rounded-xl p-4 hover-scale transition-all mb-4">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <div class="font-semibold text-lg">${new Date(w.date).toLocaleDateString()}</div>
                                        <div class="text-sm text-gray-400">${activities.length} activities ${w.volume > 0 ? ` â€¢ ${w.volume.toLocaleString()} ${state.unit} total volume` : ''}</div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick='shareWorkout(${JSON.stringify(w).replace(/'/g, "\\'")}); event.stopPropagation();' class="text-blue-400 text-2xl hover:scale-110 transition">ðŸ“¤</button>
                                        <button onclick="deleteWorkout(${w.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    ${activities.map(a => {
                                        if (a.type === 'strength') {
                                            const safeExerciseName = a.exercise ? a.exercise.replace(/'/g, "\\'") : '';
                                            const prButton = (a.weight && a.reps && parseFloat(a.weight) > 0 && parseInt(a.reps) > 0) ?
                                                `<button onclick='checkPR("${safeExerciseName}", ${a.weight}, ${a.reps}); event.stopPropagation();' class="text-xs bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green px-3 py-1 rounded font-semibold transition">PR?</button>` : '';
                                            return `<div class="flex justify-between items-center glass-strong rounded px-3 py-2"><span class="text-sm text-gray-300">${a.exercise}: ${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</span>${prButton}</div>`;
                                        } else {
                                            return `<div class="flex justify-between items-center glass-strong rounded px-3 py-2"><span class="text-sm text-gray-300">${a.exercise}: ${a.duration} min</span></div>`;
                                        }
                                    }).join('')}
                                </div>
                            </div>
                        `}).join('')}
                    </div>
                ` : ''}

                ${state.view === 'cal' ? renderCalendar() : ''}

                ${state.view === 'routines' ? `
                    <div class="space-y-6">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                            <h3 class="text-xl font-bold mb-4">Create New Routine</h3>
                            <input type="text" value="${state.currentRoutineName}" oninput="state.currentRoutineName = this.value" placeholder="Routine Name (e.g., Leg Day)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            ${state.currentRoutineSets.length > 0 ? `
                                <div class="mb-4 glass rounded-xl p-4">
                                    <h4 class="font-semibold mb-3 text-green-400">Exercises in this routine</h4>
                                    ${state.currentRoutineSets.map((a, idx) => renderActivity(a, idx, 'currentRoutineSets')).join('')}
                                </div>
                            ` : ''}
                            <div class="flex gap-2 mb-4">
                                <button onclick="state.routineActivityType = 'strength'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.routineActivityType === 'strength' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸ‹ï¸â€â™‚ï¸ Strength</button>
                                <button onclick="state.routineActivityType = 'cardio'; render();" class="flex-1 py-3 rounded-lg font-semibold transition ${state.routineActivityType === 'cardio' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸƒâ€â™‚ï¸ Cardio</button>
                            </div>
                            ${state.routineActivityType === 'strength' ? `
                                <select onchange="state.workoutExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                    ${Object.entries(exercises).map(([key, name]) => `<option value="${key}" ${state.workoutExercise === key ? 'selected' : ''}>${name}</option>`).join('')}
                                </select>
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <input type="number" value="${state.workoutWeight}" oninput="state.workoutWeight = this.value" placeholder="Weight" class="glass text-white rounded-lg px-4 py-3">
                                    <input type="number" value="${state.workoutReps}" oninput="state.workoutReps = this.value" placeholder="Reps" class="glass text-white rounded-lg px-4 py-3">
                                    <input type="number" value="${state.workoutSets}" oninput="state.workoutSets = this.value" placeholder="Sets" class="glass text-white rounded-lg px-4 py-3">
                                </div>
                            ` : `
                                <select onchange="state.workoutCardioExercise = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                    ${Object.entries(cardioExercises).map(([key, name]) => `<option value="${key}" ${state.workoutCardioExercise === key ? 'selected' : ''}>${name}</option>`).join('')}
                                </select>
                                <input type="number" value="${state.workoutCardioDuration}" oninput="state.workoutCardioDuration = this.value" placeholder="Duration (minutes)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            `}
                            <button onclick="addActivityToRoutine()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-3">
                                âž• Add to Routine
                            </button>
                            <button onclick="saveRoutine()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green py-3 rounded-lg font-semibold transition">
                                âœ… Save Routine
                            </button>
                        </div>
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                            <h3 class="text-xl font-bold mb-4">Saved Routines</h3>
                            ${state.routines.length === 0 ? `
                                <div class="text-center py-12"><p class="text-gray-400 text-lg mb-2">No routines saved yet!</p><p class="text-gray-500 text-sm">Create a new routine above</p></div>
                            ` : `
                                <div class="space-y-4">
                                    ${state.routines.map(r => `
                                        <div class="glass rounded-xl p-4">
                                            <div class="flex justify-between items-center mb-3">
                                                <span class="font-semibold text-lg text-purple-400">${r.name}</span>
                                                ${r.id > 1010 ? `<button onclick="deleteRoutine(${r.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>` : ''}
                                            </div>
                                            <div class="space-y-2">
                                                ${r.activities.slice(0, 3).map(a => {
                                                    if (a.type === 'strength') {
                                                        return `<div class="text-sm glass-strong rounded px-3 py-2">${a.exercise}: ${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</div>`;
                                                    } else {
                                                        return `<div class="text-sm glass-strong rounded px-3 py-2">${a.exercise}: ${a.duration} min</div>`;
                                                    }
                                                }).join('')}
                                                ${r.activities.length > 3 ? `<div class="text-sm text-gray-400 text-center">+${r.activities.length - 3} more exercises</div>` : ''}
                                            </div>
                                            <button onclick="showRoutinePreview(${r.id})" class="w-full mt-3 btn-primary hover-scale transition-all ripple py-2 rounded-lg font-semibold text-sm transition">
                                                View & Start Workout
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                ` : ''}
                
                ${state.view === 'prog' ? `
                    <div class="space-y-6">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in mb-6">
                            <h3 class="text-xl font-bold mb-4">Progress Visualizer</h3>
                            <select onchange="state.progressChartType = this.value; render();" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                                <option value="weight" ${state.progressChartType === 'weight' ? 'selected' : ''}>Show Weight Over Time</option>
                                <option value="volume" ${state.progressChartType === 'volume' ? 'selected' : ''}>Show Volume Over Time</option>
                                <option value="1rm" ${state.progressChartType === '1rm' ? 'selected' : ''}>Show Est. 1RM Over Time</option>
                            </select>
                            <p class="text-xs text-gray-400 text-center">Larger dots on the graph represent sets with higher reps.</p>
                        </div>
                        ${Object.entries(exercises).map(([key, name]) => {
                            const data = getProgressData(name);
                            if (data.length === 0) return '';
                            return `
                                <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                                    <h3 class="text-xl font-bold mb-4">${name}</h3>
                                    <div class="glass rounded-xl p-4 hover-scale transition-all">
                                        <canvas id="chart-${key}"></canvas>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                        ${state.workouts.length === 0 ? `
                            <div class="glass-strong rounded-3xl p-6 hover-lift fade-in text-center"><p class="text-gray-400 text-lg mb-2">No progress data yet!</p><p class="text-gray-500 text-sm">Start logging workouts to track your gains</p></div>
                        ` : ''}
                    </div>
                    ` : ''}

                ${state.view === 'prs' ? `
                    <div class="glass-strong rounded-3xl p-6 hover-lift fade-in">
                        <h3 class="text-xl font-bold mb-4">ðŸ† Personal Records</h3>
                        ${state.prs.length === 0 ? `
                            <div class="text-center py-12"><p class="text-gray-400 text-lg mb-2">No PRs logged yet!</p><p class="text-gray-500 text-sm">Log a workout and use the "PR?" button to save your bests.</p></div>
                        ` : `
                            <div class="space-y-4">
                                ${state.prs.slice().reverse().map(pr => `
                                    <div class="glass rounded-xl p-4 hover-scale transition-all">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="font-bold text-lg text-green-400">${pr.exercise}</div>
                                                <div class="text-3xl font-bold text-blue-400 my-1">${pr.weight} ${pr.unit} ${pr.reps ? `<span class="text-2xl text-gray-400">Ã— ${pr.reps}</span>` : ''}</div>
                                                <div class="text-xs text-gray-500">${new Date(pr.date).toLocaleDateString()}</div>
                                            </div>
                                            <div class="flex flex-col items-end gap-2">
                                                <button onclick='sharePR(${JSON.stringify(pr).replace(/'/g, "\\'")})' class="text-blue-400 text-2xl hover:scale-110 transition">ðŸ“¤</button>
                                                <button onclick="deletePR(${pr.id})" class="text-red-400 text-xl hover:scale-110 transition">ðŸ—‘ï¸</button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                    ` : ''}

                ${state.showNameDialog ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full">
                            <h3 class="text-xl font-bold mb-4">Profile Settings</h3>
                            <input type="text" value="${state.userName}" oninput="state.userName = this.value" placeholder="Your name" class="w-full glass text-white rounded-lg px-4 py-3 mb-3">
                            
                            <select onchange="state.gender = this.value" class="w-full glass text-white rounded-lg px-4 py-3 mb-3">
                                <option value="male" ${state.gender === 'male' ? 'selected' : ''}>Male</option>
                                <option value="female" ${state.gender === 'female' ? 'selected' : ''}>Female</option>
                            </select>
                            
                            <input type="number" value="${state.age}" oninput="state.age = this.value" placeholder="Age" class="w-full glass text-white rounded-lg px-4 py-3 mb-3">
                            
                            <input type="number" step="0.1" value="${state.bodyweight}" oninput="state.bodyweight = this.value" placeholder="Bodyweight (${state.unit})" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            
                            <div class="flex gap-3">
                                <button onclick="state.showNameDialog = false; render();" class="flex-1 glass hover:glass-strong py-3 rounded-lg transition">Cancel</button>
                                <button onclick="saveUserName()" class="flex-1 btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">Save</button>
                            </div>
                        </div>
                    </div>
                ` : ''}

                ${state.showPRDialog && state.prData ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full">
                            <h3 class="text-2xl font-bold mb-4 text-center gradient-text">Grats! New PR!</h3>
                            <div class="text-center mb-4">
                                <div class="text-lg font-bold text-green-400 mb-2">${state.prData.exercise}</div>
                                <div class="text-4xl font-bold text-blue-400 mb-1">${state.prData.weight} ${state.unit}</div>
                                <div class="text-gray-400">Ã— ${state.prData.reps} reps</div>
                            </div>
                            <p class="text-gray-400 text-sm text-center mb-6">Would you like to share this PR?</p>
                            <div class="flex gap-3">
                                <button onclick="savePR(false)" class="flex-1 glass hover:glass-strong py-3 rounded-lg font-semibold transition">Just Save</button>
                                <button onclick="savePR(true)" class="flex-1 btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold flex items-center justify-center gap-2 transition">
                                    ðŸ“¤ Share
                                </button>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${state.showBadgeModal ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full text-center">
                            <h3 class="text-2xl font-bold mb-4 text-center gradient-text-gold">Badge Unlocked!</h3>
                            ${state.newlyAwardedBadges.map(badgeId => {
                                const badge = badgeData[badgeId];
                                return `
                                <div class="mb-4">
                                    <div class="text-6xl">${badge.icon}</div>
                                    <div class="text-xl font-bold text-yellow-400 mt-2">${badge.title}</div>
                                    <p class="text-gray-400 text-sm">${badge.desc}</p>
                                </div>
                                `
                            }).join('')}
                            <button onclick="state.showBadgeModal = false; state.newlyAwardedBadges = []; render();" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                                Awesome!
                            </button>
                        </div>
                    </div>
                ` : ''}

                ${state.showRoutinePreview && state.previewRoutineId ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onclick="closeRoutinePreview()">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
                            ${(() => {
                                const routine = state.routines.find(r => r.id == state.previewRoutineId);
                                if (!routine) return '<p>Routine not found</p>';
                                return `
                                    <h3 class="text-2xl font-bold mb-4 gradient-text">${routine.name}</h3>
                                    <div class="mb-6">
                                        <h4 class="text-sm font-semibold text-gray-400 mb-3">WORKOUT PREVIEW</h4>
                                        <div class="space-y-2">
                                            ${routine.activities.map(a => {
                                                if (a.type === 'strength') {
                                                    return `<div class="glass-strong rounded-lg px-4 py-3 flex justify-between items-center">
                                                        <span class="font-semibold">${a.exercise}</span>
                                                        <span class="text-gray-400">${a.weight || '...'} ${a.unit} Ã— ${a.reps || '...'}</span>
                                                    </div>`;
                                                } else {
                                                    return `<div class="glass-strong rounded-lg px-4 py-3 flex justify-between items-center">
                                                        <span class="font-semibold">${a.exercise}</span>
                                                        <span class="text-gray-400">${a.duration} min</span>
                                                    </div>`;
                                                }
                                            }).join('')}
                                        </div>
                                    </div>
                                    <div class="flex gap-3">
                                        <button onclick="closeRoutinePreview()" class="flex-1 glass hover:glass-strong py-3 rounded-lg font-semibold transition">Cancel</button>
                                        <button onclick="startRoutineFromPreview()" class="flex-1 btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">
                                            Start This Workout
                                        </button>
                                    </div>
                                `;
                            })()}
                        </div>
                    </div>
                ` : ''}

                ${state.showCalendarModal && state.selectedCalendarDate ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onclick="closeCalendarModal()">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full overflow-y-auto max-h-[90vh]" onclick="event.stopPropagation()">
                            <h3 class="text-xl font-bold mb-4">Plans for ${new Date(state.selectedCalendarDate + 'T12:00:00').toLocaleDateString()}</h3>
                            <div class="space-y-2 mb-6">
                                ${(state.plans[state.selectedCalendarDate] || []).length === 0 ? 
                                    '<p class="text-gray-400 text-sm text-center">No plans for this day.</p>' : 
                                    state.plans[state.selectedCalendarDate].map(plan => `
                                        <div class="glass rounded-lg p-3 flex justify-between items-center">
                                            <div>
                                                <div class="font-semibold">${plan.activityName}</div>
                                                <div class="text-sm text-gray-400">
                                                    ${plan.type === 'routine' ? 'Routine' :
                                                      plan.type === 'strength' ? (plan.details.notes || 'Strength') :
                                                      `${plan.details.duration} min Cardio`}
                                                </div>
                                            </div>
                                            <button onclick="deletePlan('${plan.id}')" class="text-red-400 hover:text-red-300 text-xl">Ã—</button>
                                        </div>
                                    `).join('')
                                }
                            </div>
                            <h4 class="font-semibold mb-3">Add a Plan</h4>
                            <div class="flex gap-2 mb-4">
                                <button onclick="handlePlanTypeChange('activity')" class="flex-1 py-2 rounded-lg font-semibold text-sm transition ${state.planType === 'activity' ? 'bg-blue-600' : 'glass hover:glass-strong'}">Activity</button>
                                <button onclick="handlePlanTypeChange('routine')" class="flex-1 py-2 rounded-lg font-semibold text-sm transition ${state.planType === 'routine' ? 'bg-blue-600' : 'glass hover:glass-strong'}">Routine</button>
                            </div>
                            
                            ${state.planType === 'activity' ? `
                                <div class="flex gap-2 mb-4">
                                    <button onclick="handlePlanActivityTypeChange('strength')" class="flex-1 py-2 rounded-lg font-semibold text-sm transition ${state.planActivityType === 'strength' ? 'bg-purple-600' : 'glass hover:glass-strong'}">ðŸ‹ï¸â€â™‚ï¸ Strength</button>
                                    <button onclick="handlePlanActivityTypeChange('cardio')" class="flex-1 py-2 rounded-lg font-semibold text-sm transition ${state.planActivityType === 'cardio' ? 'bg-blue-600' : 'glass hover:glass-strong'}">ðŸƒâ€â™‚ï¸ Cardio</button>
                                </div>
                                ${state.planActivityType === 'strength' ? `
                                    <select onchange="state.planStrengthExercise = this.value" class="w-full glass text-white rounded-lg px-4 py-3 mb-2">
                                        ${Object.entries(exercises).map(([key, name]) => `<option value="${key}" ${state.planStrengthExercise === key ? 'selected' : ''}>${name}</option>`).join('')}
                                    </select>
                                ` : `
                                    <div class="grid grid-cols-2 gap-2 mb-2">
                                        <select onchange="state.planCardioExercise = this.value" class="w-full glass text-white rounded-lg px-4 py-3">
                                            ${Object.entries(cardioExercises).map(([key, name]) => `<option value="${key}" ${state.planCardioExercise === key ? 'selected' : ''}>${name}</option>`).join('')}
                                        </select>
                                        <input type="number" value="${state.planCardioDuration}" oninput="state.planCardioDuration = this.value" placeholder="Duration (min)" class="w-full glass text-white rounded-lg px-4 py-3">
                                    </div>
                                `}
                            ` : `
                                <select onchange="state.planRoutineId = this.value" class="w-full glass text-white rounded-lg px-4 py-3 mb-2">
                                    <option value="">-- Select Routine --</option>
                                    ${state.routines.map(r => `<option value="${r.id}">${r.name}</option>`).join('')}
                                </select>
                            `}
                            
                            <input type="text" value="${state.planNotes}" oninput="state.planNotes = this.value" placeholder="Notes (e.g., 3x5, RPE 8)" class="w-full glass text-white rounded-lg px-4 py-3 mb-4">
                            <button onclick="savePlan()" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition mb-4">
                                âž• Add Plan
                            </button>
                            <button onclick="logForSelectedDate()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 hover-scale transition-all ripple glow-green py-3 rounded-lg font-semibold transition">
                                ðŸ“ Log Workout for this Date
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                ${state.showTimerModal ? `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50" onclick="state.showTimerModal = false; render();">
                        <div class="glass-strong rounded-3xl p-6 hover-lift fade-in max-w-md w-full" onclick="event.stopPropagation()">
                            <h3 class="text-xl font-bold mb-4">Set Rest Timer</h3>
                            <input type="number" value="${state.restDuration}" oninput="state.restDuration = parseInt(this.value) || 60" class="w-full glass text-white text-lg rounded-lg px-4 py-3 mb-4" placeholder="Rest time (seconds)">
                            <button onclick="state.showTimerModal = false; render();" class="w-full btn-primary hover-scale transition-all ripple py-3 rounded-lg font-semibold transition">Set</button>
                        </div>
                    </div>
                ` : ''}
            `;

            // Call chart renderer *after* DOM is updated
            if (state.view === 'prog') {
                setTimeout(renderCharts, 0);
            }
            
            // Re-render calculators
            if (state.view === 'calc') {
                // We must re-run the calculate functions if the results are missing,
                // because the HTML has been re-rendered
                if (state.strengthResult) state.strengthResult = calculateStrength();
                if (state.oneRMResult) state.oneRMResult = calculate1RM();
                if (state.plateResult) state.plateResult = calculatePlates();
            }
            
            // Render strength standards chart after DOM is ready
            setTimeout(() => {
                if (state.strengthResult && document.getElementById('strengthChart')) {
                    renderStrengthChart();
                }
            }, 10);
        }
        
        // Strength Standards Chart Renderer
        function renderStrengthChart() {
            const canvas = document.getElementById('strengthChart');
            if (!canvas || !state.strengthResult) return;
            
            const ctx = canvas.getContext('2d');
            
            // Destroy existing chart if any
            if (window.strengthChartInstance) {
                window.strengthChartInstance.destroy();
            }
            
            // Get standards for current exercise/gender/category
            const standardData = {
                natural: {
                    male: {
                        squat: {untrained: 0.65, novice: 1.15, intermediate: 1.70, advanced: 2.20, elite: 2.75},
                        bench: {untrained: 0.50, novice: 0.75, intermediate: 1.25, advanced: 1.75, elite: 2.25},
                        deadlift: {untrained: 0.80, novice: 1.40, intermediate: 2.00, advanced: 2.60, elite: 3.25},
                        ohp: {untrained: 0.35, novice: 0.55, intermediate: 0.85, advanced: 1.15, elite: 1.50},
                        row: {untrained: 0.40, novice: 0.70, intermediate: 1.10, advanced: 1.50, elite: 1.90}
                    },
                    female: {
                        squat: {untrained: 0.45, novice: 0.75, intermediate: 1.20, advanced: 1.60, elite: 2.05},
                        bench: {untrained: 0.30, novice: 0.50, intermediate: 0.80, advanced: 1.10, elite: 1.45},
                        deadlift: {untrained: 0.55, novice: 0.95, intermediate: 1.45, advanced: 1.90, elite: 2.45},
                        ohp: {untrained: 0.20, novice: 0.35, intermediate: 0.55, advanced: 0.75, elite: 1.00},
                        row: {untrained: 0.25, novice: 0.45, intermediate: 0.75, advanced: 1.00, elite: 1.30}
                    }
                },
                enhanced: {
                    male: {
                        squat: {untrained: 0.65, novice: 1.15, intermediate: 1.90, advanced: 2.60, elite: 3.50},
                        bench: {untrained: 0.50, novice: 0.75, intermediate: 1.40, advanced: 2.10, elite: 2.90},
                        deadlift: {untrained: 0.80, novice: 1.40, intermediate: 2.20, advanced: 3.00, elite: 4.20},
                        ohp: {untrained: 0.35, novice: 0.55, intermediate: 0.95, advanced: 1.40, elite: 1.95},
                        row: {untrained: 0.40, novice: 0.70, intermediate: 1.25, advanced: 1.80, elite: 2.45}
                    },
                    female: {
                        squat: {untrained: 0.45, novice: 0.75, intermediate: 1.35, advanced: 1.95, elite: 2.70},
                        bench: {untrained: 0.30, novice: 0.50, intermediate: 0.95, advanced: 1.40, elite: 1.95},
                        deadlift: {untrained: 0.55, novice: 0.95, intermediate: 1.65, advanced: 2.35, elite: 3.25},
                        ohp: {untrained: 0.20, novice: 0.35, intermediate: 0.65, advanced: 0.95, elite: 1.35},
                        row: {untrained: 0.25, novice: 0.45, intermediate: 0.90, advanced: 1.30, elite: 1.75}
                    }
                }
            };
            
            const standards = standardData[state.category]?.[state.gender]?.[state.exercise];
            if (!standards) return;
            
            const userRatio = parseFloat(state.strengthResult.ratio);
            
            const labels = ['Beginner', 'Untrained', 'Novice', 'Intermediate', 'Advanced', 'Elite'];
            const values = [0, standards.untrained, standards.novice, standards.intermediate, standards.advanced, standards.elite];
            const colors = ['#9ca3af', '#60a5fa', '#4ade80', '#facc15', '#fb923c', '#ef4444'];
            
            // Find which bar the user is in
            const backgroundColors = values.map((val, idx) => {
                if (idx === 0 && userRatio < standards.untrained) return colors[idx];
                if (idx > 0 && userRatio >= values[idx-1] && userRatio < val) return colors[idx];
                if (idx === values.length - 1 && userRatio >= val) return colors[idx];
                return 'rgba(255, 255, 255, 0.1)';
            });
            
            window.strengthChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Strength Standards (Bodyweight Ratio)',
                        data: values,
                        backgroundColor: backgroundColors,
                        borderColor: colors.map(c => c),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return `${context.label}: ${context.parsed.y.toFixed(2)}x bodyweight`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#9ca3af' },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        // Initial render
        render();

        // PWA & Install Prompt Functions (abbreviated, unchanged)
        let deferredPrompt;
        const installPromptShown = localStorage.getItem('installPromptShown');
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; if (!installPromptShown) { showInstallPrompt(); } });
        function showInstallPrompt() { /* ... */ }
        window.installApp = async function() { /* ... */ };
        window.dismissInstallPrompt = function() { /* ... */ };
        if ('serviceWorker' in navigator) { /* ... */ }
        function isIOS() { return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream; }
        function isInStandaloneMode() { return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone; }
        if (isIOS() && !isInStandaloneMode() && !localStorage.getItem('iosPromptShown')) { /* ... */ }
    </script>
</body>
</html>